<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DEAR LOVE - Cyber POS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* DARK THEME (DEFAULT) */
            --bg-body: #121212;
            --bg-surface: #1E1E1E;
            --card-bg: #252525;
            --card-border: 1px solid rgba(255, 255, 255, 0.08);
            --text-main: #FFFFFF;
            --text-muted: #888888;
            --primary: #4A6CFA;
            --accent-purple: #9D59F5;
            --accent-pink: #FF4D8D;
            --accent-green: #00D084;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.2);
            --radius-l: 20px;
            --radius-m: 16px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --blur-val: 10px;
        }

        [data-theme="light"] {
            --bg-body: #F3F4F6;
            --bg-surface: #FFFFFF;
            --card-bg: #FFFFFF;
            --card-border: 1px solid rgba(0, 0, 0, 0.04);
            --text-main: #1F2937;
            --text-muted: #9CA3AF;
            --shadow-soft: 0 4px 25px rgba(0,0,0,0.05);
            --blur-val: 0px; /* Clean look for light mode */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main);
            height: 100vh; 
            overflow: hidden; 
            font-size: 13px;
            transition: background 0.3s, color 0.3s;
        }

        /* --- PRINT STYLES --- */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; padding: 40px; z-index: 99999; }
            @page { size: A4; margin: 0; }
        }

        /* --- LAYOUT --- */
        .screen { display: none; height: 100%; flex-direction: column; position: relative; background: var(--bg-body); transition: background 0.3s; }
        .screen.active { display: flex; }
        
        .top-header {
            padding: calc(var(--safe-top) + 15px) 24px 10px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-body); z-index: 50; transition: background 0.3s;
        }

        .header-profile-wrap { display: flex; align-items: center; gap: 10px; }
        .profile-pic { width: 38px; height: 38px; border-radius: 12px; object-fit: cover; border: 1px solid rgba(128,128,128,0.2); }
        .header-title { font-size: 15px; font-weight: 700; color: var(--text-main); }
        .header-sub { font-size: 11px; color: var(--text-muted); font-weight: 500; }
        
        .icon-btn { 
            color: var(--text-main); background: var(--card-bg); 
            width: 38px; height: 38px; border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; 
            border: var(--card-border); cursor: pointer; transition: 0.2s; 
            box-shadow: var(--shadow-soft);
        }
        .icon-btn:active { transform: scale(0.95); }

        .scroll-content { flex: 1; overflow-y: auto; padding: 5px 24px calc(80px + var(--safe-bottom)); scrollbar-width: none; }
        .scroll-content::-webkit-scrollbar { display: none; }

        /* --- DASHBOARD REFINED --- */
        .hero-card {
            background: linear-gradient(135deg, var(--primary), #354dbd);
            border-radius: var(--radius-l);
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(74, 108, 250, 0.3);
            position: relative; overflow: hidden;
        }
        /* Abstract shape decoration */
        .hero-card::after { content:''; position: absolute; right:-20px; top:-20px; width:100px; height:100px; background:rgba(255,255,255,0.1); border-radius:50%; }

        .hero-label { font-size: 11px; font-weight: 600; opacity: 0.8; letter-spacing: 0.5px; }
        .hero-balance { font-size: 32px; font-weight: 800; margin: 5px 0 15px; letter-spacing: -0.5px; }
        
        .hero-stats { display: flex; gap: 20px; align-items: flex-end; }
        .hs-item h4 { margin: 0; font-size: 11px; opacity: 0.7; font-weight: 500; }
        .hs-item p { margin: 2px 0 0; font-size: 16px; font-weight: 700; }
        
        .target-pill { 
            background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; 
            margin-left: auto;
        }

        .compact-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .mini-card {
            background: var(--card-bg); border: var(--card-border);
            border-radius: var(--radius-m); padding: 15px;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: var(--shadow-soft); transition: 0.2s;
        }
        .mc-head { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; color: var(--text-muted); font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .mc-val { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .mc-icon { font-size: 16px; color: var(--primary); }
        .text-inc { color: var(--accent-green); }
        .text-exp { color: var(--accent-pink); }

        .section-title { font-size: 12px; font-weight: 700; color: var(--text-muted); margin: 25px 0 10px; display: flex; justify-content: space-between; align-items: center; letter-spacing: 0.5px; }

        /* --- MENU TOOLS --- */
        .tools-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
        .tool-btn { 
            background: var(--card-bg); border: var(--card-border); 
            border-radius: 16px; padding: 12px 5px; 
            display: flex; flex-direction: column; align-items: center; gap: 8px; 
            cursor: pointer; transition: 0.2s; box-shadow: var(--shadow-soft);
        }
        .tool-btn:active { transform: scale(0.96); }
        .tool-icon-box { 
            width: 36px; height: 36px; border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 20px; 
        }
        .tool-lbl { font-size: 10px; font-weight: 600; color: var(--text-main); text-align: center; }
        
        .tb-blue { background: rgba(74, 108, 250, 0.1); color: var(--primary); }
        .tb-purp { background: rgba(157, 89, 245, 0.1); color: var(--accent-purple); }
        .tb-green { background: rgba(0, 208, 132, 0.1); color: var(--accent-green); }
        .tb-pink { background: rgba(255, 77, 141, 0.1); color: var(--accent-pink); }

        /* --- LIST ITEMS --- */
        .trans-list { display: flex; flex-direction: column; gap: 10px; }
        .trans-item { 
            background: var(--card-bg); padding: 12px 15px; border-radius: 16px; 
            display: flex; align-items: center; justify-content: space-between;
            border: var(--card-border); cursor: pointer;
        }
        .ti-left { display: flex; align-items: center; gap: 12px; }
        .ti-icon { width: 34px; height: 34px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .ti-det h4 { margin: 0 0 2px; font-size: 13px; font-weight: 600; color: var(--text-main); }
        .ti-det p { margin: 0; font-size: 10px; color: var(--text-muted); }
        .ti-right { text-align: right; }
        .ti-val { font-size: 13px; font-weight: 700; display: block; }
        .ti-time { font-size: 10px; color: var(--text-muted); }

        .inc-bg { background: rgba(0, 208, 132, 0.1); color: var(--accent-green); }
        .exp-bg { background: rgba(255, 77, 141, 0.1); color: var(--accent-pink); }
        .buy-bg { background: rgba(157, 89, 245, 0.1); color: var(--accent-purple); }
        
        /* --- BOTTOM NAV --- */
        .bottom-nav-wrap { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: center; padding-bottom: calc(var(--safe-bottom) + 15px); pointer-events: none; z-index: 100; transition: transform 0.3s; }
        .bottom-nav { 
            pointer-events: auto; background: var(--bg-surface); 
            width: 90%; max-width: 380px; height: 60px; 
            border-radius: 20px; display: flex; justify-content: space-around; align-items: center; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: var(--card-border);
        }
        .nav-item { color: var(--text-muted); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 50px; }
        .nav-item.active { color: var(--primary); }
        .nav-item .material-icons-round { font-size: 24px; }
        .fab-add { 
            width: 50px; height: 50px; background: var(--primary); 
            border-radius: 16px; display: flex; align-items: center; justify-content: center; 
            color: white; position: absolute; top: -20px; 
            box-shadow: 0 8px 20px rgba(74, 108, 250, 0.4); 
            cursor: pointer; border: 3px solid var(--bg-body); transition: 0.2s;
        }
        .fab-add:active { transform: scale(0.9); }

        /* --- FORMS & MODALS --- */
        .modal-overlay { 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); 
            display: none; position: fixed; inset: 0; z-index: 1000; 
            justify-content: center; align-items: flex-end; 
        }
        .sheet-content { 
            background: var(--bg-surface); width: 100%; max-width: 500px;
            border-radius: 24px 24px 0 0; padding: 25px; 
            max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2); 
            color: var(--text-main);
        }
        
        .clean-input { 
            width: 100%; background: var(--bg-body); 
            border: 1px solid rgba(128,128,128,0.1); 
            color: var(--text-main); border-radius: 12px; 
            padding: 14px; margin-bottom: 15px; font-size: 14px; 
            font-family: inherit; transition: 0.2s;
        }
        .clean-input:focus { border-color: var(--primary); background: var(--card-bg); }
        
        .btn-primary { 
            background: var(--primary); color: white; border: none; 
            padding: 14px; border-radius: 12px; width: 100%; 
            font-weight: 700; font-size: 13px; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(74, 108, 250, 0.3);
        }
        
        .report-tabs { background: var(--bg-body); border-radius: 12px; display: flex; padding: 4px; margin-bottom: 20px; }
        .rt-btn { flex: 1; text-align: center; padding: 8px; border-radius: 8px; font-size: 11px; color: var(--text-muted); cursor: pointer; font-weight: 600; }
        .rt-btn.active { background: var(--card-bg); color: var(--text-main); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* --- SPECIFIC PAGES TWEAKS --- */
        .input-group label { display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 6px; font-weight: 700; text-transform: uppercase; }
        
        /* CALENDAR */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 15px; }
        .cal-header { text-align: center; font-size: 10px; color: var(--text-muted); font-weight: 700; padding-bottom: 5px; }
        .cal-day { 
            background: var(--card-bg); border-radius: 8px; height: 50px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            cursor: pointer; border: 1px solid transparent; 
        }
        .cal-day.active { border-color: var(--primary); background: rgba(74, 108, 250, 0.1); }
        .cal-day.holiday { border: 1px dashed var(--accent-pink); background: rgba(255, 77, 141, 0.05); }
        .cd-date { font-size: 13px; font-weight: 700; color: var(--text-main); }
        .cd-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--accent-green); margin-top: 4px; opacity: 0; }
        .cd-dot.show { opacity: 1; }
        
        /* AI CHAT */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 13px; line-height: 1.5; margin-bottom: 10px; }
        .cb-user { background: var(--primary); color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .cb-ai { background: var(--card-bg); color: var(--text-main); margin-right: auto; border-bottom-left-radius: 4px; border: var(--card-border); }

        /* TABLES */
        .simple-table { width: 100%; border-collapse: collapse; font-size: 11px; color: var(--text-main); }
        .simple-table th { text-align: left; padding: 8px 4px; border-bottom: 1px solid var(--text-muted); opacity: 0.5; }
        .simple-table td { padding: 8px 4px; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .rank-box { width: 18px; height: 18px; background: var(--bg-body); border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen active" style="justify-content:center; padding:40px;">
        <div style="text-align:center;">
            <div style="width:70px; height:70px; background:var(--primary); border-radius:20px; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; color:white; font-size:24px; font-weight:800; box-shadow: 0 10px 30px rgba(74, 108, 250, 0.4);">DL</div>
            <h2 style="color:var(--text-main); margin:0 0 5px;">Cyber Admin</h2>
            <p style="color:var(--text-muted); font-size:12px; margin-bottom:30px;">Security Access Required</p>
            <input type="password" id="passInput" class="clean-input" placeholder="Enter PIN" style="text-align:center; font-size:18px; font-weight:bold; letter-spacing:5px;">
            <button class="btn-primary" onclick="doLogin()">UNLOCK</button>
        </div>
    </div>

    <div id="adminScreen" class="screen">
        <div class="top-header">
            <div class="header-profile-wrap" onclick="nav('settingScreen')">
                <img id="dispPhoto" class="profile-pic" src="logo.png" onerror="this.src='https://ui-avatars.com/api/?name=DL&background=random&color=fff'">
                <div>
                    <div class="header-title" id="dispStoreName">DEAR LOVE</div>
                    <div class="header-sub">Online</div>
                </div>
            </div>
            <div style="display:flex; gap:8px;">
                <div class="icon-btn" onclick="toggleTheme()"><span class="material-icons-round" id="themeIcon">dark_mode</span></div>
                <div class="icon-btn" onclick="toggleWeather()"><span class="material-icons-round wt-icon" style="color:#FFD700;">wb_sunny</span></div>
            </div>
        </div>

        <div class="scroll-content">
            <div class="hero-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="hero-label">CASH BALANCE</span>
                    <div class="target-pill" style="background:rgba(255,255,255,0.2);">
                        <span id="targetPct">0%</span> Target
                    </div>
                </div>
                <div class="hero-balance" id="realTimeProfit">Rp 0</div>
                <div class="hero-stats">
                    <div class="hs-item">
                        <h4>PROFIT HARI INI</h4>
                        <p id="netProfit">Rp 0</p>
                    </div>
                    <div class="hs-item">
                        <h4>MODAL (HPP)</h4>
                        <p id="hppStatus" style="font-size:11px; margin-top:5px; opacity:0.8;">Calculating...</p>
                    </div>
                </div>
            </div>

            <div class="compact-grid">
                <div class="mini-card">
                    <div class="mc-head"><span class="material-icons-round mc-icon">water_drop</span> Stok (L)</div>
                    <div class="mc-val" id="stokVal">0</div>
                </div>
                <div class="mini-card">
                    <div class="mc-head"><span class="material-icons-round mc-icon" style="color:var(--accent-purple);">trending_up</span> Sold (L)</div>
                    <div class="mc-val" id="todayLiter">0</div>
                </div>
                <div class="mini-card">
                    <div class="mc-head"><span class="material-icons-round mc-icon" style="color:var(--accent-green);">arrow_downward</span> Masuk</div>
                    <div class="mc-val text-inc" id="dashTodayInc" style="font-size:15px;">0</div>
                </div>
                <div class="mini-card">
                    <div class="mc-head"><span class="material-icons-round mc-icon" style="color:var(--accent-pink);">arrow_upward</span> Keluar</div>
                    <div class="mc-val text-exp" id="dashTodayExp" style="font-size:15px;">0</div>
                </div>
            </div>

            <div class="tools-row">
                <div class="tool-btn" onclick="openKasbon()">
                    <div class="tool-icon-box tb-blue"><span class="material-icons-round">book</span></div>
                    <span class="tool-lbl">Kasbon</span>
                </div>
                <div class="tool-btn" onclick="nav('insightScreen')">
                    <div class="tool-icon-box tb-purp"><span class="material-icons-round">insights</span></div>
                    <span class="tool-lbl">Analisa</span>
                </div>
                <div class="tool-btn" onclick="nav('printScreen')">
                    <div class="tool-icon-box tb-green"><span class="material-icons-round">print</span></div>
                    <span class="tool-lbl">Laporan</span>
                </div>
                <div class="tool-btn" onclick="nav('calendarScreen')">
                    <div class="tool-icon-box tb-pink"><span class="material-icons-round">calendar_month</span></div>
                    <span class="tool-lbl">Kalender</span>
                </div>
            </div>

            <div class="section-title">
                <span>Recent Activity</span>
                <span onclick="nav('historyScreen')" style="color:var(--primary); cursor:pointer; font-size:11px;">View All</span>
            </div>
            <div id="recentTrans" class="trans-list"></div>
        </div>
    </div>

    <div id="insightScreen" class="screen">
        <div class="top-header">
            <div class="icon-btn" onclick="nav('adminScreen')"><span class="material-icons-round">arrow_back</span></div>
            <div class="header-title">Analisa Bisnis</div>
            <div style="width:38px;"></div>
        </div>
        <div class="scroll-content">
            <div style="background:var(--card-bg); padding:15px; border-radius:16px; border:var(--card-border); margin-bottom:15px;">
                <div class="section-title" style="margin-top:0;">Grafik Jam (Live)</div>
                <div style="height:200px;"><canvas id="hourChart"></canvas></div>
            </div>
            <div style="background:var(--card-bg); padding:15px; border-radius:16px; border:var(--card-border); margin-bottom:20px;">
                <div class="section-title" style="margin-top:0;">Grafik Mingguan</div>
                <div style="height:200px;"><canvas id="dayChart"></canvas></div>
            </div>

            <div class="section-title">TOP HOURS (Bulan Ini)</div>
            <table class="simple-table">
                <thead><tr><th>#</th><th>Jam</th><th style="text-align:right">Liter</th><th style="text-align:right">Omzet</th></tr></thead>
                <tbody id="topHoursTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="calendarScreen" class="screen">
        <div class="top-header">
            <div class="icon-btn" onclick="nav('adminScreen')"><span class="material-icons-round">arrow_back</span></div>
            <div class="header-title">Operasional</div>
            <div id="calPeriodLabel" style="font-size:10px; color:var(--primary); font-weight:700; background:var(--card-bg); padding:4px 8px; border-radius:8px; border:var(--card-border);"></div>
        </div>
        <div class="scroll-content">
            <div class="calendar-grid">
                <div class="cal-header">M</div><div class="cal-header">S</div><div class="cal-header">S</div><div class="cal-header">R</div><div class="cal-header">K</div><div class="cal-header">J</div><div class="cal-header">S</div>
            </div>
            <div id="calendarBody" class="calendar-grid"></div>

            <div style="background:var(--card-bg); border-radius:16px; padding:20px; border:var(--card-border); margin-top:20px; text-align:center;">
                <div id="calDetailPanel">
                    <div style="color:var(--text-muted); font-style:italic;">Pilih tanggal untuk detail</div>
                </div>
            </div>
        </div>
    </div>

    <div id="aiScreen" class="screen">
        <div class="top-header">
            <div class="icon-btn" onclick="nav('adminScreen')"><span class="material-icons-round">arrow_back</span></div>
            <div class="header-title">Smart Assistant</div>
            <div style="font-size:10px; color:var(--accent-green); background:rgba(0,208,132,0.1); padding:2px 6px; border-radius:4px;">AI</div>
        </div>
        <div id="chatBox" style="flex:1; overflow-y:auto; padding:20px;">
            <div style="text-align:center; color:var(--text-muted); margin-top:50px;">
                <span class="material-icons-round" style="font-size:40px; margin-bottom:10px; opacity:0.3;">smart_toy</span>
                <p>Tanya strategi, analisa stok, atau prediksi penjualan.</p>
            </div>
        </div>
        <div style="padding:15px; display:flex; gap:10px; background:var(--bg-surface); border-top:var(--card-border);">
            <input id="aiInput" class="clean-input" style="margin:0;" placeholder="Tanya AI...">
            <button onclick="sendAIChat()" class="icon-btn" style="background:var(--primary); color:white; width:50px; border:none;"><span class="material-icons-round">send</span></button>
        </div>
    </div>

    <div id="historyScreen" class="screen">
        <div class="top-header">
            <div class="icon-btn" onclick="nav('adminScreen')"><span class="material-icons-round">arrow_back</span></div>
            <div class="header-title">Riwayat</div>
            <div class="icon-btn" onclick="clearData()" style="color:var(--accent-pink);"><span class="material-icons-round">delete</span></div>
        </div>
        <div class="scroll-content" id="fullHistoryList" class="trans-list"></div>
    </div>

    <div id="reportScreen" class="screen">
        <div class="top-header">
            <div class="icon-btn" onclick="nav('adminScreen')"><span class="material-icons-round">arrow_back</span></div>
            <div class="header-title">Laporan Keuangan</div>
            <div style="width:38px;"></div>
        </div>
        <div class="scroll-content">
            <div class="report-tabs">
                <div id="rtDay" class="rt-btn active" onclick="setReportMode('daily')">Hari Ini</div>
                <div id="rtMonth" class="rt-btn" onclick="setReportMode('monthly')">Periode</div>
                <div id="rtYear" class="rt-btn" onclick="setReportMode('yearly')">Tahunan</div>
            </div>
            
            <div style="background:var(--card-bg); padding:25px; border-radius:20px; border:var(--card-border); text-align:center; margin-bottom:20px; box-shadow:var(--shadow-soft);">
                <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;" id="rpTitle">NET PROFIT</div>
                <div style="font-size:32px; font-weight:800; color:var(--accent-green);" id="rpNet">Rp 0</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                    <div><div style="font-size:10px; color:var(--text-muted);">Omzet</div><div style="font-size:14px; font-weight:700;" id="rpOmzet">0</div></div>
                    <div><div style="font-size:10px; color:var(--text-muted);">HPP Modal</div><div style="font-size:14px; font-weight:700; color:var(--accent-pink);" id="rpHpp">0</div></div>
                    <div><div style="font-size:10px; color:var(--text-muted);">Gross Profit</div><div style="font-size:14px; font-weight:700; color:var(--primary);" id="rpGross">0</div></div>
                    <div><div style="font-size:10px; color:var(--text-muted);">Beban</div><div style="font-size:14px; font-weight:700; color:var(--accent-pink);" id="rpBeban">0</div></div>
                </div>
                <div style="margin-top:15px; padding-top:15px; border-top:1px solid rgba(128,128,128,0.1); display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:11px; font-weight:600; color:var(--accent-purple);">OWNER WITHDRAW</span>
                    <span style="font-weight:700; color:var(--accent-purple);" id="rpWd">Rp 0</span>
                </div>
            </div>
            <div id="reportContent" class="trans-list"></div>
        </div>
    </div>

    <div id="printScreen" class="screen">
        <div class="top-header">
            <div class="icon-btn" onclick="nav('adminScreen')"><span class="material-icons-round">arrow_back</span></div>
            <div class="header-title">Cetak Laporan</div>
            <div class="icon-btn" onclick="doPrint()" style="background:var(--accent-green); color:white; border:none;"><span class="material-icons-round">print</span></div>
        </div>
        <div class="scroll-content">
            <div id="printPreviewContent" style="background:white; color:black; padding:30px; border-radius:4px; font-size:12px; min-height:600px; box-shadow:0 10px 30px rgba(0,0,0,0.2);"></div>
        </div>
    </div>

    <div id="settingScreen" class="screen">
        <div class="top-header">
            <div class="icon-btn" onclick="nav('adminScreen')"><span class="material-icons-round">arrow_back</span></div>
            <div class="header-title">Pengaturan</div>
            <div style="width:38px;"></div>
        </div>
        <div class="scroll-content">
            <div style="text-align:center; margin:10px 0 30px;">
                <div style="position:relative; display:inline-block;">
                    <img id="setPhoto" src="logo.png" style="width:80px; height:80px; border-radius:24px; object-fit:cover; border:2px solid var(--primary);" onerror="this.src='https://ui-avatars.com/api/?name=DL&background=random&color=fff'">
                    <label style="position:absolute; bottom:-5px; right:-5px; background:var(--primary); color:white; width:30px; height:30px; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <span class="material-icons-round" style="font-size:16px;">edit</span>
                        <input type="file" onchange="updatePhoto(event)" style="display:none;">
                    </label>
                </div>
            </div>

            <div style="background:var(--card-bg); border-radius:20px; padding:20px; border:var(--card-border);">
                <div class="input-group">
                    <label>Nama Toko</label>
                    <input id="setStore" class="clean-input">
                </div>
                <div class="input-group">
                    <label>Alamat</label>
                    <input id="setAddr" class="clean-input">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="input-group">
                        <label>Jual / L (Rp)</label>
                        <input id="setPrice" type="number" class="clean-input">
                    </div>
                    <div class="input-group">
                        <label>Modal / L (Rp)</label>
                        <input id="setModalPrice" type="number" class="clean-input">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Koreksi Stok (L)</label>
                    <div style="display:flex; gap:10px;">
                        <input id="setStok" type="number" class="clean-input" style="margin-bottom:0;">
                        <button onclick="resetStock()" style="background:rgba(255, 77, 141, 0.1); color:var(--accent-pink); border:1px solid rgba(255, 77, 141, 0.3); border-radius:12px; font-size:11px; font-weight:700; width:100px; cursor:pointer;">RESET 0</button>
                    </div>
                </div>

                <div class="input-group" style="margin-top:15px;">
                    <label>Target Harian (Margin)</label>
                    <input id="setTarget" type="number" class="clean-input">
                </div>
                <div class="input-group">
                    <label>Groq API Key (AI)</label>
                    <input id="setGroqKey" class="clean-input" type="password">
                </div>
                
                <button class="btn-primary" onclick="saveSet()" style="margin-top:10px;">SIMPAN PERUBAHAN</button>
                <button class="btn-primary" onclick="doLogout()" style="background:transparent; color:var(--accent-pink); border:1px solid var(--accent-pink); margin-top:10px; box-shadow:none;">LOG OUT</button>
            </div>
        </div>
    </div>

    <div id="inputModal" class="modal-overlay">
        <div class="sheet-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; font-size:16px;">Transaksi Baru</h3>
                <span class="material-icons-round" onclick="closeModal('inputModal')" style="cursor:pointer; color:var(--text-muted);">close</span>
            </div>
            
            <div class="report-tabs">
                <div id="mtInc" class="rt-btn active" onclick="setMode('inc')">JUAL</div>
                <div id="mtBuy" class="rt-btn" onclick="setMode('buy')">STOK</div>
                <div id="mtExp" class="rt-btn" onclick="setMode('exp')">BEBAN</div>
                <div id="mtWd" class="rt-btn" onclick="setMode('wd')">WD</div>
            </div>

            <div id="formInc">
                <input type="number" id="admNom" class="clean-input" placeholder="0" style="font-size:28px; font-weight:800; text-align:center; padding:20px;" oninput="calcAdm()">
                
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <label style="flex:1; background:var(--bg-body); padding:10px; border-radius:12px; text-align:center; cursor:pointer; border:1px solid rgba(128,128,128,0.1);">
                        <input type="radio" name="payMethod" value="Tunai" checked> Tunai
                    </label>
                    <label style="flex:1; background:var(--bg-body); padding:10px; border-radius:12px; text-align:center; cursor:pointer; border:1px solid rgba(128,128,128,0.1);">
                        <input type="radio" name="payMethod" value="QRIS"> QRIS
                    </label>
                </div>
                <div style="text-align:center; margin-bottom:20px; font-size:14px; color:var(--accent-green); font-weight:700;">Volume: <span id="admLit">0.00 L</span></div>
                <button class="btn-primary" onclick="saveTrans('inc')">SIMPAN PENJUALAN</button>
            </div>

            <div id="formBuy" style="display:none;">
                <div class="input-group"><label>Total Biaya (Rp)</label><input type="number" id="buyNom" class="clean-input"></div>
                <div class="input-group"><label>Liter Diterima</label><input type="number" id="buyLit" class="clean-input"></div>
                <button class="btn-primary" style="background:var(--accent-purple);" onclick="saveTrans('buy')">TAMBAH STOK</button>
            </div>

            <div id="formExp" style="display:none;">
                <div class="input-group"><label>Keterangan</label><input type="text" id="descInput" class="clean-input" placeholder="cth: Listrik"></div>
                <div class="input-group"><label>Jumlah (Rp)</label><input type="number" id="expNom" class="clean-input"></div>
                <button class="btn-primary" style="background:var(--accent-pink);" onclick="saveTrans('exp')">SIMPAN PENGELUARAN</button>
            </div>

            <div id="formWd" style="display:none;">
                <div class="input-group"><label>Jumlah Withdraw</label><input type="number" id="wdNom" class="clean-input"></div>
                <button class="btn-primary" style="background:var(--accent-purple);" onclick="saveTrans('wd')">TARIK DANA</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="sheet-content">
            <h3 style="margin:0 0 20px;">Edit Transaksi</h3>
            <input type="hidden" id="editId">
            <div class="input-group">
                <label>Tipe</label>
                <select id="editType" class="clean-input">
                    <option value="inc">Penjualan</option>
                    <option value="buy">Restock</option>
                    <option value="exp">Pengeluaran</option>
                    <option value="wd">Withdraw</option>
                </select>
            </div>
            <div class="input-group"><label>Nominal</label><input type="number" id="editNom" class="clean-input"></div>
            <div id="editLiterWrap" class="input-group"><label>Liter</label><input type="number" id="editLit" class="clean-input"></div>
            <div class="input-group"><label>Catatan</label><input type="text" id="editDesc" class="clean-input"></div>
            
            <button class="btn-primary" onclick="saveEditTrans()">UPDATE DATA</button>
            <button class="btn-primary" onclick="deleteTrans()" style="background:transparent; color:var(--accent-pink); border:1px solid var(--accent-pink); margin-top:10px; box-shadow:none;">HAPUS PERMANEN</button>
        </div>
    </div>

    <div id="kasbonModal" class="modal-overlay">
        <div class="sheet-content">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Buku Kasbon</h3>
                <span class="material-icons-round" onclick="closeModal('kasbonModal')" style="cursor:pointer;">close</span>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="kasbonName" class="clean-input" placeholder="Nama" style="margin:0; flex:1;">
                <input type="number" id="kasbonNom" class="clean-input" placeholder="Rp" style="margin:0; width:100px;">
                <button onclick="addKasbon()" style="background:var(--primary); color:white; border:none; border-radius:12px; width:50px; cursor:pointer;"><span class="material-icons-round">add</span></button>
            </div>
            <div id="kasbonList" style="max-height:300px; overflow-y:auto; padding-bottom:10px;"></div>
        </div>
    </div>

    <div id="receiptModal" class="modal-overlay" style="align-items:center; justify-content:center;">
        <div style="width:85%; max-width:320px; padding:20px; border-radius:20px; background:white; color:black; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
            <div style="text-align:center; margin-bottom:10px; font-weight:800; color:#00D084; font-size:16px;">SUKSES</div>
            <div style="border:1px dashed #ccc; padding:15px; border-radius:10px; font-family:'Courier New', monospace; text-align:center;">
                <div style="font-weight:bold; font-size:16px; margin-bottom:5px;" id="rcStore">STORE</div>
                <div style="font-size:10px; margin-bottom:10px;" id="rcAddr">Addr</div>
                <div style="border-bottom:1px dashed #000; margin-bottom:10px;"></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span id="rcItem">BBM</span>
                    <span id="rcTotal" style="font-weight:bold;">Rp 0</span>
                </div>
                <div style="text-align:left; font-size:10px;" id="rcDet">0 L</div>
                <div style="text-align:center; font-size:10px; margin-top:10px; font-weight:bold;" id="rcMethod">TUNAI</div>
                <div style="font-size:9px; color:#555; margin-top:5px;" id="rcTime"></div>
            </div>
            <button class="btn-primary" onclick="closeModal('receiptModal')" style="margin-top:15px;">Tutup</button>
        </div>
    </div>

    <div class="bottom-nav-wrap">
        <div class="bottom-nav">
            <div class="nav-item active" onclick="nav('adminScreen')"><span class="material-icons-round">grid_view</span></div>
            <div class="nav-item" onclick="nav('historyScreen')"><span class="material-icons-round">receipt_long</span></div>
            <div style="width:50px;"></div> <div class="nav-item" onclick="nav('aiScreen')"><span class="material-icons-round">smart_toy</span></div>
            <div class="nav-item" onclick="nav('reportScreen')"><span class="material-icons-round">pie_chart</span></div>
            
            <div class="fab-add" onclick="openInputModal()"><span class="material-icons-round">add</span></div>
        </div>
    </div>

    <script>
        // --- CONFIG & FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyBpwNPIYhelOhkPvJsBmKvlZnaH9FVnmM4", authDomain: "pom-mini-50b1e.firebaseapp.com", projectId: "pom-mini-50b1e", storageBucket: "pom-mini-50b1e.firebasestorage.app", messagingSenderId: "77499696502", appId: "1:77499696502:web:8080c37da62a12c9566657", measurementId: "G-KRRHTTGBRF" };
        let db; try { if(typeof firebase !== 'undefined') { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); db.settings({ experimentalForceLongPolling: true, merge: true }); } } catch(e) { console.log("Firebase Offline"); }

        let data = { 
            pass: "DearLove2025", store: "DEAR LOVE", addr: "Jonggol, Jawa Barat", 
            price: 12000, modalPrice: 10000, photo: "logo.png", stokLiter: 0, 
            dailyTarget: 170000, trans: [], kasbon: [], holidays: [], groqKey: "", theme: 'dark' 
        };

        try { let saved = localStorage.getItem('dl_super_v4'); if(saved) data = { ...data, ...JSON.parse(saved) }; } catch(e) {}
        if(!Array.isArray(data.trans)) data.trans = [];

        let currentMode = 'inc', reportMode = 'daily', currentWeather = 'sunny'; 
        let selectedDetailDate = null; 
        const fmtMoney = (n) => "Rp " + parseInt(n).toLocaleString('id-ID');

        // --- THEME ---
        const applyTheme = () => {
            document.documentElement.setAttribute('data-theme', data.theme);
            document.getElementById('themeIcon').innerText = data.theme === 'light' ? 'light_mode' : 'dark_mode';
        }
        const toggleTheme = () => {
            data.theme = data.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            localStorage.setItem('dl_super_v4', JSON.stringify(data));
            renderDash(); // Re-render to update charts colors
        }
        applyTheme();

        // --- DASHBOARD LOGIC (UPDATED MARGIN) ---
        window.renderDash = () => {
            document.getElementById('dispStoreName').innerText = data.store;
            document.getElementById('dispPhoto').src = data.photo;
            let today = new Date().toLocaleDateString();
            let dInc=0, dBuy=0, dExp=0, dWd=0, dLit=0, realTimeCash=0;
            
            data.trans.forEach(t => { 
                if(t.date === today) { 
                    if(t.type === 'inc') { dInc+=t.n; dLit+=(t.l||0); if(t.metode==='Tunai') realTimeCash+=t.n; }
                    else if(t.type === 'buy') { dBuy+=t.n; realTimeCash-=t.n; }
                    else if(t.type === 'wd') { dWd+=t.n; realTimeCash-=t.n; } 
                    else { dExp+=t.n; realTimeCash-=t.n; }
                } 
            });
            
            // --- NEW DYNAMIC MARGIN LOGIC ---
            // Profit = (Liter Sold * (Selling Price - Modal Price)) - Expense
            let currentMarginPerLiter = data.price - data.modalPrice;
            let grossProfit = dLit * currentMarginPerLiter; 
            let netProfit = grossProfit - dExp;
            
            // Calculate HPP (Modal that has been sold)
            let hppSold = dLit * data.modalPrice;

            document.getElementById('realTimeProfit').innerText = fmtMoney(realTimeCash);
            document.getElementById('netProfit').innerText = fmtMoney(Math.max(0, netProfit)); 
            document.getElementById('hppStatus').innerText = `HPP Terjual: ${fmtMoney(hppSold)}`;

            // Target Progress based on Net Profit vs Target
            let target = data.dailyTarget || 150000;
            let progressPct = Math.max(0, Math.min(100, (netProfit / target) * 100)).toFixed(0);
            document.getElementById('targetPct').innerText = progressPct + "%";
            
            document.getElementById('stokVal').innerText = data.stokLiter.toFixed(1);
            document.getElementById('todayLiter').innerText = dLit.toFixed(1);
            document.getElementById('dashTodayInc').innerText = fmtMoney(dInc);
            document.getElementById('dashTodayExp').innerText = fmtMoney(dExp);
            
            document.getElementById('recentTrans').innerHTML = data.trans.slice(0, 5).map(t => makeTransItem(t)).join('');
        }

        // --- NAVIGATION & UI ---
        const toggleNav = (show) => document.querySelector('.bottom-nav-wrap').style.transform = show ? 'translateY(0)' : 'translateY(200%)';
        
        window.nav = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            let navs = document.querySelectorAll('.bottom-nav-wrap .nav-item');
            navs.forEach(n => n.classList.remove('active'));
            
            if(id === 'adminScreen') navs[0].classList.add('active');
            else if(id === 'historyScreen') navs[1].classList.add('active');
            else if(id === 'aiScreen') navs[2].classList.add('active');
            else if(id === 'reportScreen') navs[3].classList.add('active'); 

            if(id === 'adminScreen') renderDash();
            else if(id === 'historyScreen') renderHistory();
            else if(id === 'reportScreen') renderReport();
            else if(id === 'settingScreen') renderSet();
            else if(id === 'insightScreen') renderDataInsight(); 
            else if(id === 'calendarScreen') renderCalendar(); 
            else if(id === 'printScreen') generatePrintReport();
            
            toggleNav(!['loginScreen', 'editModal', 'inputModal', 'printScreen', 'kasbonModal'].includes(id));
        }

        window.openInputModal = () => { document.getElementById('inputModal').style.display='flex'; setMode('inc'); toggleNav(false); }
        window.closeModal = (id) => { document.getElementById(id).style.display='none'; toggleNav(true); }

        window.setMode = (m) => {
            currentMode = m; 
            document.querySelectorAll('.rt-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(m==='inc'?'mtInc':(m==='buy'?'mtBuy':(m==='exp'?'mtExp':'mtWd'))).classList.add('active');
            ['formInc','formBuy','formExp','formWd'].forEach(f => document.getElementById(f).style.display = 'none');
            document.getElementById(m==='inc'?'formInc':(m==='buy'?'formBuy':(m==='exp'?'formExp':'formWd'))).style.display = 'block';
        }

        // --- CRUD TRANSACTIONS ---
        window.saveTrans = async (type) => {
            let now = new Date();
            let tx = { id:Date.now(), ts:now.getTime(), date:now.toLocaleDateString(), time:now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}), type:type, weather: currentWeather };
            
            if(type === 'inc') {
                let n=parseInt(document.getElementById('admNom').value); if(!n) return;
                let l=parseFloat((n/data.price).toFixed(2)); 
                let radios = document.getElementsByName('payMethod');
                let method = 'Tunai'; for(let r of radios) { if(r.checked) method = r.value; }

                tx.n=n; tx.l=l; tx.metode=method; data.stokLiter=Math.max(0, data.stokLiter-l);
                
                if(db) await db.collection("struk_public").doc("current").set({ nominal: n, liter: l, waktu: now.toLocaleString('id-ID'), status: "PAID", metode: method, nama_toko: data.store, alamat_toko: data.addr });
                
                document.getElementById('rcStore').innerText=data.store; document.getElementById('rcAddr').innerText=data.addr; 
                document.getElementById('rcTotal').innerText=fmtMoney(n); document.getElementById('rcDet').innerText=l+" Liter"; 
                document.getElementById('rcMethod').innerText=method.toUpperCase(); document.getElementById('rcTime').innerText=now.toLocaleString(); 
                document.getElementById('receiptModal').style.display='flex';
            } else if (type === 'buy') {
                let n=parseInt(document.getElementById('buyNom').value), l=parseFloat(document.getElementById('buyLit').value); if(!n||!l) return;
                tx.n=n; tx.l=l; tx.desc="Restock"; data.stokLiter+=l;
            } else if (type === 'exp') {
                let n=parseInt(document.getElementById('expNom').value), d=document.getElementById('descInput').value; if(!n) return;
                tx.n=n; tx.desc=d||"Beban";
            } else if (type === 'wd') {
                let n=parseInt(document.getElementById('wdNom').value); if(!n) return;
                tx.n=n; tx.desc="Withdrawal";
            }

            data.trans.unshift(tx); localStorage.setItem('dl_super_v4', JSON.stringify(data));
            ['admNom','buyNom','buyLit','expNom','descInput','wdNom'].forEach(i=>document.getElementById(i).value='');
            closeModal('inputModal'); renderDash();
        }

        window.saveEditTrans = () => {
            let id=parseInt(document.getElementById('editId').value), idx=data.trans.findIndex(x=>x.id===id); if(idx<0) return;
            let oldT=data.trans[idx]; if(oldT.type==='inc') data.stokLiter+=(oldT.l||0); if(oldT.type==='buy') data.stokLiter-=(oldT.l||0);
            
            let type=document.getElementById('editType').value, n=parseInt(document.getElementById('editNom').value), l=parseFloat(document.getElementById('editLit').value)||0, d=document.getElementById('editDesc').value;
            
            data.trans[idx]={...data.trans[idx], type:type, n:n, l:l};
            if(type==='inc') { data.trans[idx].metode=d; data.stokLiter-=l; } 
            else if(type==='buy') { data.trans[idx].desc="Restock"; data.stokLiter+=l; }
            else data.trans[idx].desc=d;
            
            localStorage.setItem('dl_super_v', JSON.stringify(data)); closeModal('editModal'); if(document.getElementById('historyScreen').classList.contains('active')) renderHistory(); renderDash();
        }

        window.deleteTrans = () => {
            if(!confirm("Yakin hapus?")) return; let id=parseInt(document.getElementById('editId').value), idx=data.trans.findIndex(x=>x.id===id);
            let oldT=data.trans[idx]; if(oldT.type==='inc') data.stokLiter+=(oldT.l||0); if(oldT.type==='buy') data.stokLiter-=(oldT.l||0);
            data.trans.splice(idx,1); localStorage.setItem('dl_super_v4', JSON.stringify(data)); closeModal('editModal'); if(document.getElementById('historyScreen').classList.contains('active')) renderHistory(); renderDash();
        }

        window.openEdit = (id) => {
            let t=data.trans.find(x=>x.id===id); if(!t) return;
            document.getElementById('editId').value=id; document.getElementById('editType').value=t.type; document.getElementById('editNom').value=t.n; document.getElementById('editLit').value=t.l||0; document.getElementById('editDesc').value=t.desc||t.metode||'';
            toggleEditFields(); document.getElementById('editModal').style.display='flex'; toggleNav(false);
        }
        
        window.toggleEditFields = () => {
            let t = document.getElementById('editType').value;
            document.getElementById('editLiterWrap').style.display = (t==='exp' || t==='wd') ? 'none' : 'block';
        }

        window.renderHistory = () => { document.getElementById('fullHistoryList').innerHTML = data.trans.map(t => makeTransItem(t)).join(''); }

        window.makeTransItem = (t) => {
            let icon='local_gas_station', cls='inc-bg', title='Penjualan', val=`+ ${t.n/1000}k`;
            if(t.type==='buy'){ icon='water_drop'; cls='buy-bg'; title='Restock'; val=`- ${t.n/1000}k`; }
            else if(t.type==='exp'){ icon='payments'; cls='exp-bg'; title=t.desc||'Beban'; val=`- ${t.n/1000}k`; }
            else if(t.type==='wd'){ icon='account_balance_wallet'; cls='buy-bg'; title='Withdraw'; val=`- ${t.n/1000}k`; }
            else { title = t.metode || 'Cash'; }
            return `
            <div class="trans-item" onclick="openEdit(${t.id})">
                <div class="ti-left">
                    <div class="ti-icon ${cls}"><span class="material-icons-round">${icon}</span></div>
                    <div class="ti-det"><h4>${title}</h4><p>${t.l?t.l.toFixed(2)+' L':''}</p></div>
                </div>
                <div class="ti-right"><span class="ti-val ${t.type==='inc'?'text-inc':'text-exp'}">${val}</span><span class="ti-time">${t.time}  ${t.date}</span></div>
            </div>`;
        }

        // --- REPORTING (UPDATED MARGIN) ---
        const getPeriodRange = () => {
            let now = new Date(); let d = now.getDate();
            let start, end;
            if (d >= 18) { start = new Date(now.getFullYear(), now.getMonth(), 18); end = new Date(now.getFullYear(), now.getMonth() + 1, 17); } 
            else { start = new Date(now.getFullYear(), now.getMonth() - 1, 18); end = new Date(now.getFullYear(), now.getMonth(), 17); }
            start.setHours(0,0,0,0); end.setHours(23,59,59,999);
            return { start, end };
        }

        window.renderReport = () => {
            let gr={}, tInc=0, tExp=0, tLit=0, tWd=0;
            let filterStart = 0, filterEnd = 9999999999999;
            let today = new Date().toLocaleDateString();

            if (reportMode === 'monthly') {
                let p = getPeriodRange(); filterStart = p.start.getTime(); filterEnd = p.end.getTime();
                document.getElementById('rpTitle').innerText = "NET PROFIT (PERIODE INI)";
            } else if (reportMode === 'daily') {
                document.getElementById('rpTitle').innerText = "NET PROFIT (HARI INI)";
            } else { document.getElementById('rpTitle').innerText = "NET PROFIT (TAHUNAN)"; }

            data.trans.forEach(t => {
                let isValid = true;
                if (reportMode === 'monthly') { if(t.ts < filterStart || t.ts > filterEnd) isValid = false; } 
                else if (reportMode === 'daily') { if(t.date !== today) isValid = false; }

                if (isValid) {
                    let k = reportMode==='daily'?t.date:(reportMode==='monthly'?'Current':new Date(t.ts).getFullYear().toString());
                    if(!gr[k]) gr[k]={i:0,b:0,e:0,w:0};
                    if(t.type==='inc') { gr[k].i+=t.n; tInc+=t.n; tLit+=(t.l||0); }
                    else if(t.type==='wd') { gr[k].w+=t.n; tWd+=t.n; }
                    else if(t.type!=='buy') { gr[k].e+=t.n; tExp+=t.n; }
                }
            });
            
            // DYNAMIC MARGIN CALCULATION
            let currentMargin = data.price - data.modalPrice;
            let grossProfit = tLit * currentMargin;
            let netProfit = grossProfit - tExp;
            let totalHPP = tLit * data.modalPrice;

            document.getElementById('rpNet').innerText = fmtMoney(netProfit); 
            document.getElementById('rpOmzet').innerText = fmtMoney(tInc); 
            document.getElementById('rpHpp').innerText = "- " + fmtMoney(totalHPP);
            document.getElementById('rpGross').innerText = fmtMoney(grossProfit);
            document.getElementById('rpBeban').innerText = "- " + fmtMoney(tExp);
            document.getElementById('rpWd').innerText = fmtMoney(tWd);
            
            document.getElementById('reportContent').innerHTML=Object.keys(gr).map(k=>`
                <div class="trans-item"><div style="flex:1;"><div class="ti-det"><h4>${reportMode==='monthly'?'Laporan Periode':k}</h4></div><div style="font-size:10px; color:var(--text-muted); margin-top:5px; display:flex; gap:10px;"><span class="text-inc">Sales: ${fmtMoney(gr[k].i)}</span><span class="text-exp">Exp: ${fmtMoney(gr[k].e)}</span></div></div></div>`).join('');
        }
        window.setReportMode = (m) => { reportMode=m; document.querySelectorAll('.report-tabs .rt-btn').forEach(b=>b.classList.remove('active')); document.getElementById(m==='daily'?'rtDay':(m==='monthly'?'rtMonth':'rtYear')).classList.add('active'); renderReport(); }

        // --- CHARTS & INSIGHT ---
        window.renderDataInsight = () => {
            let hourStats = {}, hC = Array(24).fill(0), dC = Array(7).fill(0);
            let dayNames = ['Min','Sen','Sel','Rab','Kam','Jum','Sab'];
            let now = new Date(); let todayDate = now.toLocaleDateString();
            
            let weekStart = new Date(); weekStart.setDate(weekStart.getDate() - weekStart.getDay()); weekStart.setHours(0,0,0,0);
            let weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 7);

            data.trans.forEach(t => {
                if(t.type === 'inc') {
                    let d = new Date(t.ts);
                    if (t.date === todayDate) { let h = parseInt(t.time.split(':')[0]); if(!isNaN(h)) hC[h] += t.n; }
                    if (d >= weekStart && d < weekEnd) { dC[d.getDay()] += t.n; }
                    
                    if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                        let h = parseInt(t.time.split(':')[0]);
                        if(!hourStats[h]) hourStats[h] = {omzet:0, lit:0};
                        hourStats[h].omzet += t.n; hourStats[h].lit += (t.l||0);
                    }
                }
            });

            // CHART COLORS BASED ON THEME
            let gridColor = data.theme === 'light' ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)';
            let textColor = data.theme === 'light' ? '#666' : '#888';

            updateChart('hourChart', 'hourChartInstance', 'line', Array.from({length:24},(_,i)=>i), hC, 'Sales Today', gridColor, textColor);
            updateChart('dayChart', 'dayChartInstance', 'bar', dayNames, dC, 'Weekly', gridColor, textColor);

            let sortedHours = Object.keys(hourStats).map(k => ({h:k, ...hourStats[k]})).sort((a,b) => b.omzet - a.omzet).slice(0, 5);
            document.getElementById('topHoursTableBody').innerHTML = sortedHours.map((x, i) => `<tr><td><div class="rank-box" style="background:${i===0?'var(--primary)':''}; color:${i===0?'white':''}">${i+1}</div></td><td style="font-weight:600;">${x.h}:00</td><td style="text-align:right;">${x.lit.toFixed(1)}</td><td style="text-align:right; font-weight:600;">${fmtMoney(x.omzet)}</td></tr>`).join('') || '<tr><td colspan="4" style="text-align:center; padding:15px; color:var(--text-muted);">No data</td></tr>';
        }

        // --- CALENDAR ---
        window.renderCalendar = () => {
            let { start, end } = getPeriodRange();
            document.getElementById('calPeriodLabel').innerText = `${start.getDate()} ${start.toLocaleString('id-ID',{month:'short'})} - ${end.getDate()} ${end.toLocaleString('id-ID',{month:'short'})}`;

            let dateMap = {}; let loopDate = new Date(start);
            while(loopDate <= end) { dateMap[loopDate.toLocaleDateString()] = { omzet:0, hours:{} }; loopDate.setDate(loopDate.getDate() + 1); }

            data.trans.forEach(t => { if (t.type === 'inc') { let d = t.date; if(dateMap[d]) { dateMap[d].omzet += t.n; let h = parseInt(t.time.split(':')[0]); dateMap[d].hours[h] = (dateMap[d].hours[h] || 0) + 1; } } });

            let calHTML = ""; let sortedKeys = Object.keys(dateMap).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            for(let i=0; i<new Date(start).getDay(); i++) calHTML += `<div></div>`;

            sortedKeys.forEach(k => {
                let item = dateMap[k];
                let hasData = item.omzet > 0 ? 'show' : '';
                calHTML += `<div class="cal-day" onclick="selectDate('${k}')" id="cell-${k.replace(/\//g,'-')}"><div class="cd-date">${k.split('/')[0]}</div><div class="cd-dot ${hasData}"></div></div>`;
            });
            document.getElementById('calendarBody').innerHTML = calHTML;
        }

        window.selectDate = (dateStr) => {
            document.querySelectorAll('.cal-day').forEach(d => d.style.borderColor='transparent');
            document.getElementById(`cell-${dateStr.replace(/\//g,'-')}`).style.borderColor='var(--primary)';
            let omzet = 0; data.trans.forEach(t => { if(t.date === dateStr && t.type === 'inc') omzet += t.n; });
            document.getElementById('calDetailPanel').innerHTML = `<div style="font-weight:700; font-size:16px; margin-bottom:5px; color:var(--text-main);">${dateStr}</div><div style="color:var(--text-muted);">Total Omzet: <span style="color:var(--text-main); font-weight:700;">${fmtMoney(omzet)}</span></div>`;
        }

        function updateChart(id, iN, t, l, d, lb, gc, tc) {
            const ctx=document.getElementById(id).getContext('2d'); if(window[iN]) window[iN].destroy();
            Chart.defaults.color=tc; Chart.defaults.borderColor=gc;
            window[iN] = new Chart(ctx, { type:t, data:{ labels:l, datasets:[{ label:lb, data:d, backgroundColor:t==='bar'?'#9D59F5':'rgba(74,108,250,0.1)', borderColor:t==='bar'?'#9D59F5':'#4A6CFA', borderWidth:2, tension:0.4, fill:t==='line', pointRadius:0, pointHoverRadius:4 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{grid:{color:gc}, ticks:{display:false}} } } });
        }

        // --- PRINT ---
        window.generatePrintReport = () => {
            let { start, end } = getPeriodRange();
            let tInc=0, tExp=0, tLit=0;
            data.trans.forEach(t => { 
                let d = new Date(t.ts);
                if(d >= start && d <= end) {
                   if(t.type==='inc') { tInc+=t.n; tLit+=(t.l||0); } else if(t.type!=='buy' && t.type!=='wd') { tExp+=t.n; } 
                }
            });
            let margin = data.price - data.modalPrice;
            let net = (tLit * margin) - tExp;

            let html = `
                <div style="font-family:sans-serif; text-align:center;">
                    <h2 style="margin:0;">${data.store}</h2>
                    <p>${data.addr}</p>
                    <hr>
                    <h3 style="margin:20px 0;">LAPORAN PERIODE</h3>
                    <p>${start.toLocaleDateString()} - ${end.toLocaleDateString()}</p>
                    <table style="width:100%; border-collapse:collapse; margin-top:20px; text-align:left;">
                        <tr style="border-bottom:1px solid #ddd;"><td style="padding:10px;">Total Omzet</td><td style="text-align:right;">${fmtMoney(tInc)}</td></tr>
                        <tr style="border-bottom:1px solid #ddd;"><td style="padding:10px;">Liter Terjual</td><td style="text-align:right;">${tLit.toFixed(2)} L</td></tr>
                        <tr style="border-bottom:1px solid #ddd;"><td style="padding:10px;">Beban Operasional</td><td style="text-align:right;">(${fmtMoney(tExp)})</td></tr>
                        <tr><td style="padding:15px 10px; font-weight:bold;">NET PROFIT</td><td style="text-align:right; font-weight:bold; font-size:16px;">${fmtMoney(net)}</td></tr>
                    </table>
                    <div style="margin-top:50px; text-align:right;"><p>Admin</p><br><br><p>( ................. )</p></div>
                </div>`;
            document.getElementById('printPreviewContent').innerHTML = html;
            document.getElementById('printArea').innerHTML = html;
        }
        window.doPrint = () => window.print();

        // --- AI CHAT ---
        window.sendAIChat = async () => {
            let i = document.getElementById('aiInput'); let m = i.value; let b = document.getElementById('chatBox');
            if(!m) return; i.value=''; b.innerHTML += `<div class="chat-bubble cb-user">${m}</div>`;
            if(!data.groqKey){ b.innerHTML += `<div class="chat-bubble cb-ai" style="color:var(--accent-pink);">API Key Missing</div>`; return; }
            
            b.innerHTML += `<div id="aiLoad" style="font-size:10px; color:var(--text-muted); margin-left:10px;">Thinking...</div>`;
            let stats = { stock: data.stokLiter, price: data.price, modal: data.modalPrice };
            let prompt = `Role: Business Consultant. Context: Gas Station (Pertamini). Data: Stock ${stats.stock}L, Margin/L ${stats.price - stats.modal}. Question: "${m}". Keep it short and actionable.`;
            
            try { 
                let r = await fetch("https://api.groq.com/openai/v1/chat/completions",{ method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${data.groqKey}`}, body:JSON.stringify({ model:"llama-3.3-70b-versatile", messages:[{role:"user",content:prompt}] }) }); 
                let j = await r.json(); document.getElementById('aiLoad').remove(); 
                b.innerHTML += `<div class="chat-bubble cb-ai">${marked.parse(j.choices[0].message.content)}</div>`; b.scrollTop = b.scrollHeight; 
            } catch(e){ document.getElementById('aiLoad').remove(); b.innerHTML += `<div class="chat-bubble cb-ai">Error connection.</div>`; }
        }

        // --- SYSTEM ---
        window.doLogin=()=>{if(document.getElementById('passInput').value===data.pass){localStorage.setItem('dl_log','1');nav('adminScreen');}else alert("Wrong PIN");}
        window.doLogout=()=>{localStorage.removeItem('dl_log');nav('loginScreen');}
        window.clearData=()=>{if(confirm("RESET DATA?")){data.trans=[];data.kasbon=[];localStorage.setItem('dl_super_v4',JSON.stringify(data));renderDash();}}
        window.calcAdm = () => { let n=parseInt(document.getElementById('admNom').value)||0; document.getElementById('admLit').innerText=(n/data.price).toFixed(2)+" L"; }
        window.toggleWeather = () => { const i = document.querySelector('.wt-icon'); if(currentWeather === 'sunny') { currentWeather = 'rain'; i.innerText = 'thunderstorm'; i.style.color = 'var(--primary)'; } else { currentWeather = 'sunny'; i.innerText = 'wb_sunny'; i.style.color = '#FFD700'; } }
        window.renderSet = () => { document.getElementById('setStore').value = data.store; document.getElementById('setAddr').value = data.addr; document.getElementById('setPrice').value = data.price; document.getElementById('setModalPrice').value = data.modalPrice; document.getElementById('setStok').value = data.stokLiter; document.getElementById('setGroqKey').value = data.groqKey || ""; document.getElementById('setTarget').value = data.dailyTarget || 170000; document.getElementById('setPhoto').src = data.photo; }
        window.saveSet = () => { data.store=document.getElementById('setStore').value; data.addr=document.getElementById('setAddr').value; data.price=parseInt(document.getElementById('setPrice').value); data.modalPrice=parseInt(document.getElementById('setModalPrice').value); data.stokLiter=parseFloat(document.getElementById('setStok').value); data.groqKey=document.getElementById('setGroqKey').value; data.dailyTarget=parseInt(document.getElementById('setTarget').value); localStorage.setItem('dl_super_v4', JSON.stringify(data)); alert("Tersimpan"); renderDash(); }
        window.resetStock = () => { if(confirm("Reset stok ke 0?")) { data.stokLiter = 0; localStorage.setItem('dl_super_v4', JSON.stringify(data)); renderSet(); } }
        window.updatePhoto=(e)=>{let r=new FileReader(); r.onload=v=>{data.photo=v.target.result; renderSet();}; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]);}
        window.openKasbon = () => {
            document.getElementById('kasbonModal').style.display='flex'; toggleNav(false);
            const renderK = () => { document.getElementById('kasbonList').innerHTML = data.kasbon.map((k,i) => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(128,128,128,0.1); font-size:13px;"><span>${k.name}</span><div style="display:flex; gap:10px;"><span style="font-weight:bold;">${fmtMoney(k.nom)}</span><span onclick="delKasbon(${i})" style="color:red; cursor:pointer;">x</span></div></div>`).join(''); };
            window.addKasbon = () => { let nm=document.getElementById('kasbonName').value, no=parseInt(document.getElementById('kasbonNom').value); if(nm&&no){ data.kasbon.push({name:nm, nom:no}); localStorage.setItem('dl_super_v4', JSON.stringify(data)); document.getElementById('kasbonName').value=''; document.getElementById('kasbonNom').value=''; renderK(); } };
            window.delKasbon = (i) => { data.kasbon.splice(i,1); localStorage.setItem('dl_super_v4', JSON.stringify(data)); renderK(); };
            renderK();
        }

        const startApp=()=>{ if(localStorage.getItem('dl_log')) nav('adminScreen'); }
        window.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>