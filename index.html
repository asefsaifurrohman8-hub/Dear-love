<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DEAR LOVE - Cyber POS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="console.warn('ChartJS gagal load')"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" onerror="console.warn('Firebase gagal load')"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" onerror="console.warn('Firestore gagal load')"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" onerror="console.warn('Marked gagal load')"></script>

    <style>
        /* --- CYBER THEME VARIABLES --- */
        :root {
            --bg-body: #1F202F;
            --bg-gradient: linear-gradient(180deg, #242538 0%, #151620 100%);
            --card-bg: rgba(255, 255, 255, 0.04);
            --card-border: 1px solid rgba(255, 255, 255, 0.08);
            --primary: #4A6CFA;
            --accent-purple: #9D59F5;
            --accent-pink: #F54EA2;
            --accent-green: #2ECC71;
            --accent-wd: #D946EF; 
            --text-main: #FFFFFF;
            --text-muted: #8F90A6;
            --radius-l: 24px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            height: 100vh; overflow: hidden; font-size: 14px;
        }

        /* --- PRINT STYLES (A4) --- */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; padding: 20px; z-index: 99999; }
            @page { size: A4; margin: 2cm; }
        }

        /* --- LAYOUT UTILS --- */
        .screen { display: none; height: 100%; flex-direction: column; position: relative; }
        .screen.active { display: flex; }
        
        .top-header {
            padding: calc(var(--safe-top) + 20px) 24px 10px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50; 
            background: transparent;
        }

        .header-profile-wrap { display: flex; align-items: center; gap: 12px; }
        .profile-pic { width: 42px; height: 42px; border-radius: 14px; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); }
        .header-title { font-size: 16px; font-weight: 700; color: var(--text-main); letter-spacing: 0.5px; }
        .header-sub { font-size: 12px; color: var(--text-muted); }
        .icon-btn { color: var(--text-main); background: rgba(255,255,255,0.05); width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); border: var(--card-border); transition: 0.2s; cursor: pointer; }
        .icon-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }

        .scroll-content {
            flex: 1; overflow-y: auto; 
            padding: 10px 24px calc(60px + var(--safe-bottom) + 30px); 
            scrollbar-width: none;
        }
        .scroll-content::-webkit-scrollbar { display: none; }

        /* --- DASHBOARD STYLES --- */
        .hero-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 28px;
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
        }

        .hero-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .hero-label { font-size: 12px; color: var(--text-muted); font-weight: 500; letter-spacing: 0.5px; }
        
        .hero-balance {
            font-size: 42px;
            font-weight: 700;
            color: white;
            margin: 10px 0;
            letter-spacing: -1.5px;
            line-height: 1;
        }

        .hero-stats-row {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .hs-item { flex: 1; }
        .hs-val { font-size: 15px; font-weight: 600; color: white; margin-bottom: 2px; }
        .hs-lbl { font-size: 11px; color: var(--text-muted); }

        .mini-target-bar {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }
        .mt-fill {
            height: 100%;
            width: 0%;
            background: #2ECC71;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .info-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 16px;
            border: var(--card-border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 110px;
        }

        .ic-icon { width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 10px; }
        .ic-blue { background: rgba(74, 108, 250, 0.15); color: var(--primary); }
        .ic-pink { background: rgba(245, 78, 162, 0.15); color: var(--accent-pink); }
        .ic-green { background: rgba(46, 204, 113, 0.15); color: var(--accent-green); }
        .ic-val { font-size: 18px; font-weight: 700; color: white; }
        .ic-lbl { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        .section-title { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }

        /* --- CARDS & TOOLS --- */
        .cyber-card { background: var(--card-bg); border: var(--card-border); border-radius: var(--radius-l); padding: 20px; margin-bottom: 20px; backdrop-filter: blur(10px); }

        .tools-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 30px; }
        .tool-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .tool-icon { width: 100%; aspect-ratio: 1/1; border-radius: 22px; display: flex; align-items: center; justify-content: center; position: relative; border: 1px solid rgba(255,255,255,0.08); transition: 0.2s; background: rgba(255,255,255,0.03); }
        .tool-item:active .tool-icon { transform: scale(0.95); background: rgba(255,255,255,0.06); }
        .t-blue { color: #4A6CFA; } .t-purple { color: #9D59F5; } .t-pink { color: #F54EA2; } .t-green { color: #2ECC71; }
        .tool-label { font-size: 11px; color: var(--text-muted); font-weight: 500; text-align:center; line-height:1.2; }

        .trans-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .trans-item:last-child { border-bottom: none; }
        .ti-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 14px; font-size: 18px; }
        .ti-icon.inc { background: rgba(46, 204, 113, 0.1); color: #2ECC71; }
        .ti-icon.buy { background: rgba(157, 89, 245, 0.1); color: #9D59F5; }
        .ti-icon.exp { background: rgba(245, 78, 162, 0.1); color: #F54EA2; }
        .ti-icon.wd  { background: rgba(217, 70, 239, 0.1); color: #D946EF; }
        .ti-info h4 { margin: 0 0 2px 0; font-size: 14px; font-weight: 600; color: var(--text-main); }
        .ti-info p { margin: 0; font-size: 11px; color: var(--text-muted); }
        .ti-val { font-size: 14px; font-weight: 700; display: block; text-align: right; }
        .ti-time { font-size: 10px; color: var(--text-muted); text-align: right; margin-top: 2px; display: block; }
        .val-plus { color: #2ECC71; } .val-minus { color: var(--text-main); }

        /* --- NAVIGATION --- */
        .bottom-nav-wrap { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: center; z-index: 999; padding-bottom: calc(var(--safe-bottom) + 15px); pointer-events: none; }
        .bottom-nav { pointer-events: auto; background: rgba(31, 32, 47, 0.95); width: 88%; max-width: 380px; height: 64px; border-radius: 24px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); backdrop-filter: blur(20px); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #6E6F89; cursor: pointer; position: relative; }
        .nav-item.active { color: var(--primary); }
        .nav-item .material-icons-round { font-size: 26px; transition: 0.3s; }
        .nav-item.active .material-icons-round { transform: translateY(-4px); }
        .nav-dot { width: 4px; height: 4px; background: var(--primary); border-radius: 50%; position: absolute; bottom: -8px; opacity: 0; transition: 0.3s; }
        .nav-item.active .nav-dot { opacity: 1; bottom: -4px; }
        .fab-add { width: 54px; height: 54px; background: linear-gradient(135deg, #2ECC71, #27ae60); border-radius: 18px; display: flex; align-items: center; justify-content: center; color: #fff; position: absolute; top: -20px; box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3); cursor: pointer; transition: 0.2s; border: 2px solid #1F202F; }
        .fab-add:active { transform: scale(0.9); }

        /* --- FORMS & MODALS --- */
        .modal-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; position: fixed; inset: 0; z-index: 1000; justify-content: center; align-items: flex-end; }
        .sheet-content { background: #1F202F; border-top: 1px solid rgba(255,255,255,0.1); padding: 24px; position: absolute; bottom: 0; left: 0; right: 0; border-radius: 30px 30px 0 0; max-height: 90vh; overflow-y: auto; padding-bottom: calc(var(--safe-bottom) + 20px); box-shadow: 0 -10px 40px rgba(0,0,0,0.5); }
        
        .clean-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 16px; padding: 16px; margin-bottom: 15px; outline: none; font-size: 14px; transition: 0.3s; }
        .clean-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); }
        
        .btn-primary { background: linear-gradient(135deg, var(--primary), #354dbd); padding: 16px; border-radius: 16px; width: 100%; border: none; font-weight: 700; color: white; cursor: pointer; transition: 0.2s; font-size: 14px; letter-spacing: 0.5px; box-shadow: 0 5px 15px rgba(74, 108, 250, 0.2); }
        .btn-primary:active { transform: scale(0.98); }
        
        .report-tabs { background: rgba(0,0,0,0.2); border-radius: 16px; display: flex; padding: 4px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .rt-btn { flex: 1; text-align: center; padding: 10px; border-radius: 12px; font-size: 12px; color: var(--text-muted); cursor: pointer; transition: 0.2s; font-weight: 600; }
        .rt-btn.active { background: rgba(255,255,255,0.1); color: white; }

        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .rg-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .rg-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        .rg-val { font-size: 16px; font-weight: 700; color: white; }

        .text-green { color: var(--accent-green); } .text-red { color: var(--accent-pink); } .text-blue { color: var(--primary); }
        .input-group label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        
        .btn-reset-stock { background: rgba(245, 78, 162, 0.1); color: var(--accent-pink); border: 1px solid rgba(245, 78, 162, 0.2); margin-top: 5px; width: auto; padding: 10px 20px; font-size: 12px; }

        /* ANALYTICS DATA STYLE */
        .stat-rank-item { display: flex; align-items: center; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .rank-num { width: 30px; height: 30px; background: var(--primary); border-radius: 10px; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; margin-right: 15px; font-size: 14px; }
        .rank-info { flex: 1; }
        .rank-title { font-size: 14px; font-weight: 700; color: white; margin-bottom: 4px; }
        .rank-det { font-size: 11px; color: var(--text-muted); }
        .rank-val { text-align: right; }
        .rv-omzet { font-size: 13px; font-weight: 700; color: var(--accent-green); display: block; }
        .rv-profit { font-size: 10px; color: var(--text-muted); display: block; margin-top: 2px; }

        /* --- INSIGHT CALENDAR STYLE --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 Hari */
            gap: 6px;
            margin-bottom: 20px;
        }
        .cal-header {
            text-align: center; font-size: 10px; color: var(--text-muted); 
            text-transform: uppercase; font-weight: 700; padding-bottom: 5px;
        }
        .cal-day {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            min-height: 70px;
            padding: 6px;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .cal-day.active { border-color: var(--primary); background: rgba(74, 108, 250, 0.1); }
        .cal-day.holiday { background: rgba(245, 78, 162, 0.1); border: 1px dashed var(--accent-pink); }
        .cd-date { font-size: 10px; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; }
        .cd-omzet { font-size: 9px; color: white; font-weight: 600; text-align: right; }
        .cd-peaks { display: flex; flex-wrap: wrap; gap: 2px; justify-content: flex-end; margin-top: 4px; }
        .peak-badge { font-size: 8px; background: var(--accent-green); color: black; padding: 1px 3px; border-radius: 3px; font-weight: 700; }
        .cal-empty { background: transparent; }
        
        .day-bar-wrap { margin-bottom: 20px; }
        .day-bar-item { display: flex; align-items: center; margin-bottom: 5px; }
        .db-label { width: 40px; font-size: 10px; color: var(--text-muted); }
        .db-track { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .db-fill { height: 100%; background: var(--primary); }
        .db-val { width: 60px; text-align: right; font-size: 10px; color: white; font-weight: 600; }

        /* --- TOGGLE SWITCH --- */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-pink); }
        input:checked + .slider:before { transform: translateX(16px); }
    </style>
</head>
<body>

    <div id="splashScreen" style="position:fixed; inset:0; background:#151620; z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column; transition:0.5s;">
        <img src="logo.png" style="width:100px; height:100px; border-radius:25px; object-fit:cover; margin-bottom:20px; box-shadow:0 0 50px rgba(74, 108, 250, 0.3);" onerror="this.src='https://ui-avatars.com/api/?name=DL&background=random&color=fff'">
        <div style="color:white; font-weight:800; font-size:28px;">DEAR LOVE</div>
        <div style="color:rgba(255,255,255,0.5); font-size:12px; margin-top:5px; letter-spacing:4px;">CYBER POS</div>
    </div>

    <div id="printArea" style="display:none;"></div>

    <div id="loginScreen" class="screen active">
        <div style="text-align:center; padding: 40px; height: 100%; display: flex; flex-direction: column; justify-content: center;">
            <div style="width:80px; height:80px; background:linear-gradient(135deg, var(--primary), var(--accent-purple)); border-radius:24px; margin:0 auto 30px; display:flex; align-items:center; justify-content:center; color:white; font-size:24px; font-weight:800; box-shadow: 0 0 40px rgba(74, 108, 250, 0.3);">DL</div>
            <h2 style="color:white; margin:0 0 10px;">Cyber Admin</h2>
            <p style="color:var(--text-muted); margin-bottom:40px;">Enter security PIN to continue</p>
            <input type="password" id="passInput" class="clean-input" placeholder="••••" style="text-align:center; font-size:24px; letter-spacing:8px; font-weight:bold; background:rgba(0,0,0,0.2);">
            <button class="btn-primary" onclick="doLogin()">UNLOCK SYSTEM</button>
        </div>
    </div>

    <div id="adminScreen" class="screen">
        <div class="top-header">
            <div class="header-profile-wrap" onclick="nav('settingScreen')">
                <img id="dispPhoto" class="profile-pic" src="logo.png" onerror="this.src='https://ui-avatars.com/api/?name=DL&background=random&color=fff'">
                <div>
                    <div class="header-sub">System Online</div>
                    <div class="header-title" id="dispStoreName">DEAR LOVE</div>
                </div>
            </div>
            <div id="weatherBtn" class="icon-btn" onclick="toggleWeather()">
                <span class="material-icons-round wt-icon" style="color:#FFD700;">wb_sunny</span>
            </div>
        </div>

        <div class="scroll-content">
            <div class="hero-card">
                <div class="hero-top">
                    <span class="hero-label">CASH IN DRAWER</span>
                    <span style="font-size:10px; color:var(--accent-green); background:rgba(46,204,113,0.1); padding:2px 8px; border-radius:6px; font-weight:bold;">LIVE</span>
                </div>
                
                <div class="hero-balance" id="realTimeProfit">Rp 0</div>
                
                <div class="hero-stats-row">
                    <div class="hs-item">
                        <div class="hs-val text-green" id="netProfit">Rp 0</div>
                        <div class="hs-lbl">Current Profit</div>
                    </div>
                    <div class="hs-item" style="border-left:1px solid rgba(255,255,255,0.1); padding-left:15px;">
                         <div class="hs-val" id="targetPct">0%</div>
                         <div class="hs-lbl">Margin Target</div>
                         <div class="mini-target-bar"><div id="targetBar" class="mt-fill"></div></div>
                    </div>
                </div>
                <div id="hppStatus" style="font-size:10px; color:var(--text-muted); margin-top:15px; font-weight:600; text-align:center; opacity:0.7;">CALCULATING HPP...</div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <div>
                        <div class="ic-icon ic-blue"><span class="material-icons-round">water_drop</span></div>
                        <div class="ic-val" id="stokVal">0</div>
                    </div>
                    <div class="ic-lbl">Stock (Liter)</div>
                </div>
                <div class="info-card">
                    <div>
                        <div class="ic-icon ic-pink"><span class="material-icons-round">trending_up</span></div>
                        <div class="ic-val" id="todayLiter">0</div>
                    </div>
                    <div class="ic-lbl">Sold Today (Liter)</div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <div>
                        <div class="ic-icon ic-green"><span class="material-icons-round">arrow_downward</span></div>
                        <div class="ic-val text-green" id="dashTodayInc">0</div>
                    </div>
                    <div class="ic-lbl">Uang Masuk (Hari Ini)</div>
                </div>
                <div class="info-card">
                    <div>
                        <div class="ic-icon ic-pink"><span class="material-icons-round">arrow_upward</span></div>
                        <div class="ic-val text-red" id="dashTodayExp">0</div>
                    </div>
                    <div class="ic-lbl">Uang Keluar (Hari Ini)</div>
                </div>
            </div>

            <div class="tools-grid">
                <div class="tool-item" onclick="openKasbon()"><div class="tool-icon"><span class="material-icons-round t-blue">book</span></div><span class="tool-label">Kasbon</span></div>
                
                <div class="tool-item" onclick="nav('insightScreen')"><div class="tool-icon"><span class="material-icons-round t-purple">insights</span></div><span class="tool-label">Data<br>Insight</span></div>
                
                <div class="tool-item" onclick="nav('printScreen')"><div class="tool-icon"><span class="material-icons-round t-green">print</span></div><span class="tool-label">Laporan<br>A4</span></div>
                
                <div class="tool-item" onclick="nav('polaScreen')"><div class="tool-icon"><span class="material-icons-round t-pink">ssid_chart</span></div><span class="tool-label">Grafik</span></div>
            </div>

            <div class="section-title">
                <span>Recent Activity</span>
                <span onclick="nav('historyScreen')" style="font-size:11px; color:var(--primary); cursor:pointer;">View All</span>
            </div>
            <div id="recentTrans"></div>
        </div>

        <div class="bottom-nav-wrap">
            <div class="bottom-nav">
                <div class="nav-item active" onclick="nav('adminScreen')"><span class="material-icons-round">grid_view</span><div class="nav-dot"></div></div>
                <div class="nav-item" onclick="nav('historyScreen')"><span class="material-icons-round">receipt_long</span><div class="nav-dot"></div></div>
                <div style="width:70px;"></div>
                <div class="nav-item" onclick="nav('aiScreen')"><span class="material-icons-round">smart_toy</span><div class="nav-dot"></div></div>
                <div class="nav-item" onclick="nav('reportScreen')"><span class="material-icons-round">pie_chart</span><div class="nav-dot"></div></div>
                <div class="fab-add" onclick="openInputModal()"><span class="material-icons-round">add</span></div>
            </div>
        </div>
    </div>

    <div id="insightScreen" class="screen">
        <div class="top-header">
            <span class="material-icons-round icon-btn" onclick="nav('adminScreen')">arrow_back</span>
            <span class="header-title">Analisa Detail</span>
            <span id="insightPeriodLabel" style="font-size:10px; color:var(--primary); font-weight:700; border:1px solid var(--primary); padding:4px 8px; border-radius:8px;"></span>
        </div>
        <div class="scroll-content">
            
            <div class="section-title" style="margin-top:10px;">RINGKASAN PERIODE (18 s/d 17)</div>
            <div class="info-grid">
                <div class="info-card" style="min-height:80px;">
                    <div style="font-size:11px; color:var(--text-muted);">Total Omzet</div>
                    <div style="font-size:18px; font-weight:700; color:white;" id="insTotalOmzet">0</div>
                </div>
                <div class="info-card" style="min-height:80px;">
                    <div style="font-size:11px; color:var(--text-muted);">Total Volume</div>
                    <div style="font-size:18px; font-weight:700; color:white;" id="insTotalVol">0 L</div>
                </div>
            </div>

            <div class="cyber-card">
                <div class="section-title" style="margin-top:0;">
                    <span>HARI TERAMAI (MINGGUAN)</span>
                    <span style="font-size:10px; color:var(--accent-purple);">AVG</span>
                </div>
                <div id="weeklyBarChart" class="day-bar-wrap"></div>
            </div>

            <div class="section-title">
                <span>KALENDER PERFORMA (30 HARI)</span>
                <span style="font-size:10px; color:var(--text-muted);">Klik tgl utk detail/libur</span>
            </div>
            
            <div class="calendar-grid" id="calendarHeader">
                <div class="cal-header">M</div><div class="cal-header">S</div><div class="cal-header">S</div><div class="cal-header">R</div><div class="cal-header">K</div><div class="cal-header">J</div><div class="cal-header">S</div>
            </div>
            <div class="calendar-grid" id="calendarBody"></div>

        </div>
    </div>

    <div id="dateDetailModal" class="modal-overlay">
        <div class="sheet-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0; color:white;" id="ddTitle">Detail Tanggal</h3>
                <span class="material-icons-round" onclick="closeModal('dateDetailModal')" style="color:white; cursor:pointer;">close</span>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px;">
                <div>
                    <div style="font-weight:700; font-size:14px; color:white;">STATUS TOKO LIBUR</div>
                    <div style="font-size:10px; color:var(--text-muted);">Tandai jika toko tutup (tidak dihitung performa)</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="holidayToggle" onchange="toggleHoliday()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="section-title">PERFORMA JAM PER HARI</div>
            <div id="ddHoursList"></div>
        </div>
    </div>

    <div id="aiScreen" class="screen">
        <div class="top-header">
            <span class="material-icons-round icon-btn" onclick="nav('adminScreen')">arrow_back</span>
            <div class="header-title">AI Assistant</div>
            <div style="font-size:10px; color:var(--accent-green); background:rgba(46,204,113,0.1); padding:2px 6px; border-radius:4px;">ONLINE</div>
        </div>
        <div id="chatBox" style="flex:1; overflow-y:auto; padding:20px;">
            <div style="text-align:center; color:var(--text-muted); font-size:12px; margin-top:30px;">
                <span class="material-icons-round" style="font-size:40px; margin-bottom:10px; display:block; opacity:0.5;">smart_toy</span>
                AI Ready. Tanya strategi penjualan atau analisa stok.
            </div>
        </div>
        <div style="padding:20px; display:flex; gap:10px; background:#1F202F; border-top:1px solid rgba(255,255,255,0.05);">
            <input id="aiInput" class="clean-input" style="margin:0;" placeholder="Tanya sesuatu...">
            <button onclick="sendAIChat()" class="icon-btn" style="background:var(--primary); width:50px;"><span class="material-icons-round">send</span></button>
        </div>
    </div>

    <div id="polaScreen" class="screen">
        <div class="top-header">
            <span class="material-icons-round icon-btn" onclick="nav('adminScreen')">arrow_back</span>
            <span class="header-title">Grafik Penjualan</span>
            <span></span>
        </div>
        <div class="scroll-content">
            <div class="cyber-card" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px; font-weight:600; text-transform:uppercase;">Weather Impact</div>
                    <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;">
                        <span class="material-icons-round" style="color:#FFD700; font-size:20px;">wb_sunny</span>
                        <span style="font-size:18px; font-weight:700;">Avg: <span id="sunnyAvg" class="text-green">0</span> L</span>
                    </div>
                     <div style="display:flex; align-items:center; gap:8px;">
                        <span class="material-icons-round" style="color:var(--primary); font-size:20px;">thunderstorm</span>
                        <span style="font-size:18px; font-weight:700;">Avg: <span id="rainAvg" class="text-blue">0</span> L</span>
                    </div>
                </div>
                <div style="width:60px; height:60px; border-radius:50%; background:rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center;">
                    <span class="material-icons-round" style="font-size:32px; color:var(--text-muted);">cloud_sync</span>
                </div>
            </div>

             <div class="cyber-card" style="height:320px;">
                 <div class="section-title">
                     <span>Grafik Jam (Hari Ini)</span>
                     <span style="font-size:10px; color:var(--accent-green);">LIVE</span>
                 </div>
                 <canvas id="hourChart"></canvas>
             </div>
             <div class="cyber-card" style="height:320px;">
                 <div class="section-title">
                     <span>Grafik Hari (Minggu Ini)</span>
                     <span style="font-size:10px; color:var(--accent-purple);">WEEKLY</span>
                 </div>
                 <canvas id="dayChart"></canvas>
             </div>
        </div>
    </div>

    <div id="historyScreen" class="screen">
        <div class="top-header">
            <span class="material-icons-round icon-btn" onclick="nav('adminScreen')">arrow_back</span>
            <span class="header-title">Transaction History</span>
            <span class="material-icons-round icon-btn" onclick="clearData()" style="color:var(--accent-pink);">delete</span>
        </div>
        <div class="scroll-content" id="fullHistoryList"></div>
    </div>

    <div id="reportScreen" class="screen">
        <div class="top-header">
            <span class="material-icons-round icon-btn" onclick="nav('adminScreen')">arrow_back</span>
            <span class="header-title">Financial Report</span>
            <span></span>
        </div>
        <div class="scroll-content">
            <div class="report-tabs">
                <div id="rtDay" class="rt-btn active" onclick="setReportMode('daily')">Daily</div>
                <div id="rtMonth" class="rt-btn" onclick="setReportMode('monthly')">Monthly (18-17)</div>
                <div id="rtYear" class="rt-btn" onclick="setReportMode('yearly')">Yearly</div>
            </div>
            
            <div class="cyber-card" style="padding:20px;">
                <div style="text-align:center; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:10px;">
                    <div style="font-size:11px; color:var(--text-muted); margin-bottom:5px; text-transform:uppercase;">NET PROFIT (MARGIN 3000)</div>
                    <div style="font-size:36px; font-weight:800; color:#2ECC71;" id="rpNet">Rp 0</div>
                </div>

                <div class="report-grid">
                    <div class="rg-item">
                        <div class="rg-label">Penjualan</div>
                        <div class="rg-val" id="rpOmzet">0</div>
                    </div>
                    <div class="rg-item">
                        <div class="rg-label">Laba Kotor</div>
                        <div class="rg-val text-blue" id="rpGross">0</div>
                    </div>
                    <div class="rg-item">
                        <div class="rg-label">HPP Modal</div>
                        <div class="rg-val text-red" id="rpHpp">0</div>
                    </div>
                    <div class="rg-item">
                        <div class="rg-label">Beban (Exp)</div>
                        <div class="rg-val text-red" id="rpBeban">0</div>
                    </div>
                </div>
                
                <div style="margin-top:10px; background:rgba(217, 70, 239, 0.1); border-radius:12px; padding:12px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:11px; color:var(--accent-wd); font-weight:600;">OWNER WITHDRAW (WD)</span>
                    <span style="font-weight:700; color:var(--accent-wd);" id="rpWd">Rp 0</span>
                </div>
            </div>
            
            <h4 style="margin:20px 0 10px 0; color:var(--text-muted); font-size:12px; text-transform:uppercase;">Detail Report</h4>
            <div id="reportContent"></div>
        </div>
    </div>

    <div id="printScreen" class="screen">
        <div class="top-header">
            <span class="material-icons-round icon-btn" onclick="nav('adminScreen')">arrow_back</span>
            <span class="header-title">Laporan A4</span>
            <span class="material-icons-round icon-btn" onclick="doPrint()" style="color:var(--accent-green);">print</span>
        </div>
        <div class="scroll-content">
            <div id="printPreviewContent" style="background:white; color:black; padding:20px; border-radius:4px; font-size:12px; min-height:800px; margin-bottom:20px;"></div>
        </div>
    </div>

    <div id="settingScreen" class="screen">
        <div class="top-header">
            <span class="material-icons-round icon-btn" onclick="nav('adminScreen')">arrow_back</span>
            <span class="header-title">System Settings</span>
            <span></span>
        </div>
        <div class="scroll-content">
            <div style="text-align:center; margin:10px 0 30px;">
                <div style="position:relative; display:inline-block;">
                    <img id="setPhoto" src="logo.png" style="width:90px; height:90px; border-radius:30px; object-fit:cover; border:2px solid var(--primary); box-shadow:0 0 20px rgba(74, 108, 250, 0.3);" onerror="this.src='https://ui-avatars.com/api/?name=DL&background=random&color=fff'">
                    <label style="position:absolute; bottom:-5px; right:-5px; background:var(--primary); color:white; width:32px; height:32px; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
                        <span class="material-icons-round" style="font-size:16px;">edit</span>
                        <input type="file" onchange="updatePhoto(event)" style="display:none;">
                    </label>
                </div>
            </div>

            <div class="cyber-card">
                <div class="input-group">
                    <label>STORE NAME</label>
                    <input id="setStore" class="clean-input">
                </div>
                <div class="input-group">
                    <label>ADDRESS</label>
                    <input id="setAddr" class="clean-input">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="input-group">
                        <label>JUAL/L (Rp)</label>
                        <input id="setPrice" type="number" class="clean-input">
                    </div>
                    <div class="input-group">
                        <label>MODAL/L (Rp)</label>
                        <input id="setModalPrice" type="number" class="clean-input">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>MANUAL STOCK ADJUSTMENT (L)</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input id="setStok" type="number" class="clean-input" style="margin-bottom:0;">
                        <button class="btn-primary btn-reset-stock" onclick="resetStock()">RESET 0</button>
                    </div>
                </div>

                <div class="input-group" style="margin-top:15px;">
                    <label>DAILY TARGET (MARGIN)</label>
                    <input id="setTarget" type="number" class="clean-input">
                </div>
                <div class="input-group">
                    <label>GROQ API KEY</label>
                    <input id="setGroqKey" class="clean-input" type="password">
                </div>
                
                <button class="btn-primary" onclick="saveSet()" style="margin-top:10px;">UPDATE SYSTEM</button>
                <button class="btn-primary" onclick="doLogout()" style="background:rgba(255,255,255,0.05); color:var(--accent-pink); margin-top:15px; box-shadow:none; border:1px solid rgba(255,255,255,0.1);">LOG OUT</button>
            </div>
        </div>
    </div>

    <div id="inputModal" class="modal-overlay">
        <div class="sheet-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; font-size:18px; font-weight:700; color:white;">New Transaction</h3>
                <span class="material-icons-round" onclick="closeModal('inputModal')" style="cursor:pointer; color:var(--text-muted);">close</span>
            </div>
            
            <div class="report-tabs">
                <div id="mtInc" class="rt-btn active" onclick="setMode('inc')">SALE</div>
                <div id="mtBuy" class="rt-btn" onclick="setMode('buy')">STOCK</div>
                <div id="mtExp" class="rt-btn" onclick="setMode('exp')">EXPENSE</div>
                <div id="mtWd" class="rt-btn" onclick="setMode('wd')">WD</div>
            </div>

            <div id="formInc">
                <input type="number" id="admNom" class="clean-input" placeholder="Rp" style="font-size:24px; font-weight:800;" oninput="calcAdm()">
                <div style="text-align:right; font-size:12px; color:var(--accent-green); margin-bottom:15px;">Volume: <span id="admLit">0</span> L</div>
                <button class="btn-primary" onclick="saveTrans('inc')">SUBMIT SALE</button>
            </div>

            <div id="formBuy" style="display:none;">
                <div class="input-group">
                    <label>Total Cost (Rp)</label>
                    <input type="number" id="buyNom" class="clean-input" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Liters Received</label>
                    <input type="number" id="buyLit" class="clean-input" placeholder="0">
                </div>
                <button class="btn-primary" style="background:var(--accent-purple);" onclick="saveTrans('buy')">REFILL STOCK</button>
            </div>

            <div id="formExp" style="display:none;">
                <div class="input-group">
                    <label>Description</label>
                    <input type="text" id="descInput" class="clean-input" placeholder="e.g. Listrik">
                </div>
                <div class="input-group">
                    <label>Amount (Rp)</label>
                    <input type="number" id="expNom" class="clean-input" placeholder="0">
                </div>
                <button class="btn-primary" style="background:var(--accent-pink);" onclick="saveTrans('exp')">SAVE EXPENSE</button>
            </div>

            <div id="formWd" style="display:none;">
                <div class="input-group">
                    <label>Withdraw Amount</label>
                    <input type="number" id="wdNom" class="clean-input" placeholder="Rp">
                </div>
                <button class="btn-primary" style="background:var(--accent-wd);" onclick="saveTrans('wd')">WITHDRAW</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="sheet-content">
            <h3 style="color:white; margin-bottom:20px;">Edit Transaction</h3>
            <input type="hidden" id="editId">
            <div class="input-group">
                <label>Type</label>
                <select id="editType" class="clean-input" onchange="toggleEditFields()" style="background:#222;">
                    <option value="inc">Sale</option>
                    <option value="buy">Restock</option>
                    <option value="exp">Expense</option>
                    <option value="wd">Withdraw (WD)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Nominal</label>
                <input type="number" id="editNom" class="clean-input">
            </div>
            <div id="editLiterWrap" class="input-group">
                <label>Liter</label>
                <input type="number" id="editLit" class="clean-input">
            </div>
            <div class="input-group">
                <label>Note</label>
                <input type="text" id="editDesc" class="clean-input">
            </div>
            <button class="btn-primary" onclick="saveEditTrans()">UPDATE</button>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                <button class="btn-primary" onclick="deleteTrans()" style="background:rgba(245, 78, 162, 0.1); color:var(--accent-pink); box-shadow:none;">DELETE</button>
                <button class="btn-primary" onclick="closeModal('editModal')" style="background:transparent; box-shadow:none;">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="kasbonModal" class="modal-overlay">
        <div class="sheet-content">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:white;">Kasbon (Debt)</h3>
                <span class="material-icons-round" onclick="closeModal('kasbonModal')" style="color:white; cursor:pointer;">close</span>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="kasbonName" class="clean-input" placeholder="Name" style="margin:0; flex:1;">
                <input type="number" id="kasbonNom" class="clean-input" placeholder="Rp" style="margin:0; width:100px;">
                <button onclick="addKasbon()" style="background:var(--primary); color:white; border:none; border-radius:12px; width:50px; cursor:pointer;"><span class="material-icons-round">add</span></button>
            </div>
            <div id="kasbonList" style="max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="receiptModal" class="modal-overlay" style="align-items:center; justify-content:center;">
        <div class="popup-content" style="width:85%; max-width:320px; padding:20px; border-radius:20px; background:white; color:black;">
            <div style="text-align:center; margin-bottom:15px; font-weight:700; color:#2ECC71;">TRANSACTION SUCCESS</div>
            <div style="border:1px dashed #ccc; padding:15px; border-radius:10px; font-family:'Courier New', monospace; text-align:center;">
                <div style="font-weight:bold; font-size:16px; margin-bottom:5px;" id="rcStore">DEAR LOVE</div>
                <div style="font-size:10px; margin-bottom:15px;" id="rcAddr"></div>
                <div style="border-bottom:1px dashed #000; margin-bottom:10px;"></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span id="rcItem">Fuel</span>
                    <span id="rcTotal" style="font-weight:bold;">Rp 10.000</span>
                </div>
                <div style="text-align:left; font-size:10px;" id="rcDet">1.00 Liter</div>
                <div style="border-bottom:1px dashed #000; margin:10px 0;"></div>
                <div style="font-size:10px;" id="rcTime">12/12/2025</div>
            </div>
            <button class="btn-primary" onclick="closeModal('receiptModal')" style="margin-top:20px;">Close</button>
        </div>
    </div>

    <script>
        // --- CONFIG & INIT ---
        const firebaseConfig = { apiKey: "AIzaSyBpwNPIYhelOhkPvJsBmKvlZnaH9FVnmM4", authDomain: "pom-mini-50b1e.firebaseapp.com", projectId: "pom-mini-50b1e", storageBucket: "pom-mini-50b1e.firebasestorage.app", messagingSenderId: "77499696502", appId: "1:77499696502:web:8080c37da62a12c9566657", measurementId: "G-KRRHTTGBRF" };
        let db; 
        try { if(typeof firebase !== 'undefined') { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); db.settings({ experimentalForceLongPolling: true, merge: true }); } } catch(e) { console.log("Firebase Offline"); }

        let data = { 
            pass: "DearLove2025", 
            store: "DEAR LOVE", 
            addr: "Jl. Raya Pertamini", 
            price: 12000, 
            modalPrice: 10000, 
            photo: "logo.png", 
            stokLiter: 0, 
            dailyTarget: 170000, 
            trans: [], 
            kasbon: [],
            holidays: [], 
            groqKey: "" 
        };

        try { let saved = localStorage.getItem('dl_super_v4'); if(saved) data = { ...data, ...JSON.parse(saved) }; } catch(e) {}
        if(!Array.isArray(data.trans)) data.trans = [];
        if(!Array.isArray(data.kasbon)) data.kasbon = [];
        if(!Array.isArray(data.holidays)) data.holidays = [];

        let currentMode = 'inc', reportMode = 'daily', currentWeather = 'sunny'; 
        let selectedDetailDate = null; // For Calendar Detail
        const fmtMoney = (n) => "Rp " + parseInt(n).toLocaleString('id-ID');

        // --- DASHBOARD LOGIC (THE CORE) ---
        window.renderDash = () => {
            document.getElementById('dispStoreName').innerText = data.store;
            document.getElementById('dispPhoto').src = data.photo;
            let today = new Date().toLocaleDateString();
            let dInc=0, dBuy=0, dExp=0, dWd=0, dLit=0, realTimeCash=0;
            
            data.trans.forEach(t => { 
                if(t.date === today) { 
                    if(t.type === 'inc') { dInc+=t.n; dLit+=(t.l||0); if(t.metode==='Tunai') realTimeCash+=t.n; }
                    else if(t.type === 'buy') { dBuy+=t.n; realTimeCash-=t.n; }
                    else if(t.type === 'wd') { dWd+=t.n; realTimeCash-=t.n; } 
                    else { dExp+=t.n; realTimeCash-=t.n; }
                } 
            });
            
            // LOGIKA HPP & MARGIN
            let hppTerpakai = dLit * data.modalPrice; 
            let breakEvenPoint = hppTerpakai + dExp; 
            let marginForce = (dLit * 3000) - dExp;
            
            let statusText = "";
            let statusColor = "";
            let progressPct = 0;

            if (dInc < breakEvenPoint) {
                progressPct = 0;
                let kurang = breakEvenPoint - dInc;
                statusText = `MODAL BELUM KEMBALI (KURANG ${fmtMoney(kurang)})`;
                statusColor = "var(--accent-pink)";
            } else {
                let target = data.dailyTarget || 170000;
                let valBar = Math.max(0, marginForce);
                progressPct = Math.min(100, (valBar / target) * 100).toFixed(1);
                
                statusText = "PROFIT MARGIN 3000 ACTIVE";
                statusColor = "var(--accent-green)";
            }
            
            document.getElementById('realTimeProfit').innerText = fmtMoney(realTimeCash);
            document.getElementById('netProfit').innerText = fmtMoney(Math.max(0, marginForce)); 
            document.getElementById('targetPct').innerText = progressPct + "%";
            document.getElementById('targetBar').style.width = progressPct + "%";
            
            let stEl = document.getElementById('hppStatus');
            stEl.innerText = statusText;
            stEl.style.color = statusColor;
            
            document.getElementById('stokVal').innerText = data.stokLiter.toFixed(2);
            document.getElementById('todayLiter').innerText = dLit.toFixed(2);
            
            // Update New Dashboard Cards (Cash Flow Today)
            document.getElementById('dashTodayInc').innerText = fmtMoney(dInc);
            document.getElementById('dashTodayExp').innerText = fmtMoney(dExp);
            
            document.getElementById('recentTrans').innerHTML = data.trans.slice(0, 5).map(t => makeTransItem(t)).join('');
        }

        // --- NAVIGATION & UI ---
        const toggleNav = (show) => document.querySelector('.bottom-nav-wrap').style.transform = show ? 'translateY(0)' : 'translateY(200%)';
        
        window.nav = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            let navs = document.querySelectorAll('.bottom-nav-wrap .nav-item');
            navs.forEach(n => n.classList.remove('active'));
            
            if(id === 'adminScreen') navs[0].classList.add('active');
            else if(id === 'historyScreen') navs[1].classList.add('active');
            else if(id === 'aiScreen') navs[2].classList.add('active');
            else if(id === 'reportScreen') navs[3].classList.add('active'); 

            if(id === 'adminScreen') renderDash();
            else if(id === 'historyScreen') renderHistory();
            else if(id === 'polaScreen') renderPola();
            else if(id === 'reportScreen') renderReport();
            else if(id === 'settingScreen') renderSet();
            else if(id === 'insightScreen') renderInsight(); 
            else if(id === 'printScreen') generatePrintReport(); // Trigger Print Generation
            
            toggleNav(!['loginScreen', 'editModal', 'inputModal', 'dateDetailModal', 'printScreen', 'kasbonModal'].includes(id));
        }

        window.openInputModal = () => { document.getElementById('inputModal').style.display='flex'; setMode('inc'); toggleNav(false); }
        window.closeModal = (id) => { document.getElementById(id).style.display='none'; toggleNav(true); }

        window.setMode = (m) => {
            currentMode = m; 
            document.querySelectorAll('.rt-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(m==='inc'?'mtInc':(m==='buy'?'mtBuy':(m==='exp'?'mtExp':'mtWd'))).classList.add('active');
            ['formInc','formBuy','formExp','formWd'].forEach(f => document.getElementById(f).style.display = 'none');
            document.getElementById(m==='inc'?'formInc':(m==='buy'?'formBuy':(m==='exp'?'formExp':'formWd'))).style.display = 'block';
        }

        // --- CRUD FUNCTIONS ---
        window.saveTrans = async (type) => {
            let now = new Date();
            let tx = { id:Date.now(), ts:now.getTime(), date:now.toLocaleDateString(), time:now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}), type:type, weather: currentWeather };
            
            if(type === 'inc') {
                let n=parseInt(document.getElementById('admNom').value); if(!n) return;
                let l=parseFloat((n/data.price).toFixed(2)); tx.n=n; tx.l=l; tx.metode='Tunai'; data.stokLiter=Math.max(0, data.stokLiter-l);
                
                if(db) await db.collection("struk_public").doc("current").set({ nominal: n, liter: l, waktu: now.toLocaleString('id-ID'), status: "PAID", nama_toko: data.store, alamat_toko: data.addr });
                
                document.getElementById('rcStore').innerText=data.store; document.getElementById('rcAddr').innerText=data.addr; document.getElementById('rcTotal').innerText=fmtMoney(n); document.getElementById('rcDet').innerText=l+" Liter"; document.getElementById('rcTime').innerText=now.toLocaleString(); document.getElementById('receiptModal').style.display='flex';
            } else if (type === 'buy') {
                let n=parseInt(document.getElementById('buyNom').value), l=parseFloat(document.getElementById('buyLit').value); if(!n||!l) return;
                tx.n=n; tx.l=l; tx.desc="Restock"; data.stokLiter+=l;
            } else if (type === 'exp') {
                let n=parseInt(document.getElementById('expNom').value), d=document.getElementById('descInput').value; if(!n) return;
                if (n > 70000) { alert("GAGAL: Pengeluaran dibatasi maksimal Rp 70.000 untuk penghematan!"); return; }
                tx.n=n; tx.desc=d||"Expense";
            } else if (type === 'wd') {
                let n=parseInt(document.getElementById('wdNom').value); if(!n) return;
                tx.n=n; tx.desc="Withdrawal (Owner)";
            }

            data.trans.unshift(tx); localStorage.setItem('dl_super_v4', JSON.stringify(data));
            ['admNom','buyNom','buyLit','expNom','descInput','wdNom'].forEach(i=>document.getElementById(i).value='');
            closeModal('inputModal'); renderDash();
        }

        window.saveEditTrans = () => {
            let id=parseInt(document.getElementById('editId').value), idx=data.trans.findIndex(x=>x.id===id); if(idx<0) return;
            let oldT=data.trans[idx]; if(oldT.type==='inc') data.stokLiter+=(oldT.l||0); if(oldT.type==='buy') data.stokLiter-=(oldT.l||0);
            
            let type=document.getElementById('editType').value, n=parseInt(document.getElementById('editNom').value), l=parseFloat(document.getElementById('editLit').value)||0, d=document.getElementById('editDesc').value;
            
            data.trans[idx]={...data.trans[idx], type:type, n:n, l:l};
            if(type==='inc') { data.trans[idx].metode=d; data.stokLiter-=l; } 
            else if(type==='buy') { data.trans[idx].desc="Restock"; data.stokLiter+=l; }
            else if(type==='wd') { data.trans[idx].desc=d||"Withdrawal"; }
            else data.trans[idx].desc=d;
            
            localStorage.setItem('dl_super_v4', JSON.stringify(data)); closeModal('editModal'); if(document.getElementById('historyScreen').classList.contains('active')) renderHistory(); renderDash();
        }

        window.deleteTrans = () => {
            if(!confirm("Delete?")) return; let id=parseInt(document.getElementById('editId').value), idx=data.trans.findIndex(x=>x.id===id);
            let oldT=data.trans[idx]; if(oldT.type==='inc') data.stokLiter+=(oldT.l||0); if(oldT.type==='buy') data.stokLiter-=(oldT.l||0);
            data.trans.splice(idx,1); localStorage.setItem('dl_super_v4', JSON.stringify(data)); closeModal('editModal'); if(document.getElementById('historyScreen').classList.contains('active')) renderHistory(); renderDash();
        }

        window.openEdit = (id) => {
            let t=data.trans.find(x=>x.id===id); if(!t) return;
            document.getElementById('editId').value=id; document.getElementById('editType').value=t.type; document.getElementById('editNom').value=t.n; document.getElementById('editLit').value=t.l||0; document.getElementById('editDesc').value=t.desc||t.metode||'';
            toggleEditFields(); document.getElementById('editModal').style.display='flex'; toggleNav(false);
        }
        
        window.toggleEditFields = () => {
            let t = document.getElementById('editType').value;
            document.getElementById('editLiterWrap').style.display = (t==='exp' || t==='wd') ? 'none' : 'block';
        }

        // --- FULL FUNCTIONS (NO SHORTCUTS) ---
        window.renderHistory = () => {
            document.getElementById('fullHistoryList').innerHTML = data.trans.map(t => makeTransItem(t)).join('');
        }

        window.makeTransItem = (t) => {
            let ic='inc', iname='local_gas_station', s='+', c='val-plus', ti='Sale', su=(t.l||0).toFixed(2)+" L";
            if(t.type==='buy'){ ic='buy'; iname='water_drop'; s='-'; c='val-minus'; ti='Restock'; su="+"+t.l+" L"; }
            else if(t.type==='exp'){ ic='exp'; iname='payments'; s='-'; c='val-minus'; ti=t.desc; su="Expense"; }
            else if(t.type==='wd'){ ic='wd'; iname='account_balance_wallet'; s='-'; c='val-minus'; ti='Withdraw'; su="Ambil Profit"; }
            else ti=t.metode||"Cash";
            return `<div class="trans-item" onclick="openEdit(${t.id})"><div style="display:flex; align-items:center;"><div class="ti-icon ${ic}"><span class="material-icons-round">${iname}</span></div><div class="ti-info"><h4>${ti}</h4><p>${su}</p></div></div><div><span class="ti-val ${c}">${s} ${t.n/1000}k</span><span class="ti-time">${t.time}</span></div></div>`;
        }

        // --- REPORTS (UPDATED TO PERIOD 18-17) ---
        const getCustomPeriod = (ts) => { let d = new Date(ts); if (d.getDate() >= 18) d.setMonth(d.getMonth() + 1); return d.toLocaleString('id-ID', { month: 'long', year: 'numeric' }); }

        window.renderReport = () => {
            let gr={}, tInc=0, tExp=0, tLit=0, tWd=0;
            
            // Logic for Monthly Mode: Only active period 18-17
            let filterStart = 0, filterEnd = 9999999999999;
            if (reportMode === 'monthly') {
                let p = getPeriodRange(); // Re-use the global helper
                filterStart = p.start.getTime();
                filterEnd = p.end.getTime();
            }

            data.trans.forEach(t => {
                // Filter date range first
                if (t.ts >= filterStart && t.ts <= filterEnd) {
                    let k = reportMode==='daily'?t.date:(reportMode==='monthly'?'Current Period (18-17)':new Date(t.ts).getFullYear().toString());
                    if(!gr[k]) gr[k]={i:0,b:0,e:0,w:0};
                    if(t.type==='inc') { gr[k].i+=t.n; tInc+=t.n; tLit+=t.l; }
                    else if(t.type==='buy') { gr[k].b+=t.n; } 
                    else if(t.type==='wd') { gr[k].w+=t.n; tWd+=t.n; }
                    else { gr[k].e+=t.n; tExp+=t.n; }
                }
            });
            
            let forcedMarginTotal = (tLit * 3000) - tExp;
            let totalHPP = tLit * data.modalPrice;
            let forcedGross = tLit * 3000;

            document.getElementById('rpNet').innerText = fmtMoney(forcedMarginTotal); 
            document.getElementById('rpOmzet').innerText = fmtMoney(tInc); 
            document.getElementById('rpHpp').innerText = "- " + fmtMoney(totalHPP);
            document.getElementById('rpGross').innerText = fmtMoney(forcedGross);
            document.getElementById('rpBeban').innerText = "- " + fmtMoney(tExp);
            document.getElementById('rpWd').innerText = fmtMoney(tWd);
            
            document.getElementById('reportContent').innerHTML=Object.keys(gr).map(k=>`
                <div class="trans-item">
                    <div style="flex:1;">
                        <div class="ti-info"><h4>${k}</h4></div>
                        <div style="font-size:10px; color:var(--text-muted); margin-top:5px; display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                            <span class="text-green">Sales: ${fmtMoney(gr[k].i)}</span>
                            <span class="text-red">Exp: ${fmtMoney(gr[k].e)}</span>
                            <span style="color:var(--accent-wd);">WD: ${fmtMoney(gr[k].w)}</span>
                        </div>
                    </div>
                </div>`).join('');
        }
        window.setReportMode = (m) => { reportMode=m; document.querySelectorAll('.report-tabs .rt-btn').forEach(b=>b.classList.remove('active')); document.getElementById(m==='daily'?'rtDay':(m==='monthly'?'rtMonth':'rtYear')).classList.add('active'); renderReport(); }

        // --- CHARTS ---
        window.renderPola = () => {
            let sL=0, sC=0, rL=0, rC=0;
            let hC = Array(24).fill(0); 
            let dayNames = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
            let dC = Array(7).fill(0); 

            let todayDate = new Date().toLocaleDateString();
            let now = new Date();
            let startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0,0,0,0);
            let endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 7);

            data.trans.forEach(t => {
                if(t.type==='inc') {
                    if(t.weather==='rain') { rL+=t.l; rC++; } else { sL+=t.l; sC++; }
                    
                    if (t.date === todayDate) {
                        let h = parseInt(t.time.split(':')[0]); 
                        if(!isNaN(h)) hC[h] += t.n;
                    }

                    let tDateObj = new Date(t.ts);
                    if (tDateObj >= startOfWeek && tDateObj < endOfWeek) {
                        let dayIdx = tDateObj.getDay(); 
                        dC[dayIdx] += t.n;
                    }
                }
            });

            document.getElementById('sunnyAvg').innerText = sC>0?(sL/sC).toFixed(1):"0"; 
            document.getElementById('rainAvg').innerText = rC>0?(rL/rC).toFixed(1):"0";
            
            updateChart('hourChart', 'hourChartInstance', 'line', Array.from({length:24},(_,i)=>`${i}`), hC, 'Sales Today');
            updateChart('dayChart', 'dayChartInstance', 'bar', dayNames, dC, 'Sales This Week');
        }

        function updateChart(id, iN, t, l, d, lb) {
            const ctx=document.getElementById(id).getContext('2d'); if(window[iN]) window[iN].destroy();
            Chart.defaults.color='#8F90A6'; Chart.defaults.borderColor='rgba(255,255,255,0.05)';
            window[iN] = new Chart(ctx, { 
                type:t, 
                data:{
                    labels:l,
                    datasets:[{
                        label:lb,
                        data:d,
                        backgroundColor:t==='bar'?'#9D59F5':'rgba(74,108,250,0.2)',
                        borderColor:t==='bar'?'#9D59F5':'#4A6CFA',
                        borderWidth:2,
                        tension:0.4,
                        fill:t==='line',
                        pointBackgroundColor:'#1F202F'
                    }]
                }, 
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{legend:{display:false}},
                    scales:{
                        x:{grid:{display:false}},
                        y:{grid:{color:'rgba(255,255,255,0.05)'}}
                    }
                } 
            });
        }

        // --- NEW: INSIGHT SCREEN LOGIC ---
        const getPeriodRange = () => {
            let now = new Date();
            let currentDay = now.getDate();
            let start, end;
            
            if (currentDay >= 18) {
                // Period: This Month 18th - Next Month 17th
                start = new Date(now.getFullYear(), now.getMonth(), 18);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 17);
            } else {
                // Period: Last Month 18th - This Month 17th
                start = new Date(now.getFullYear(), now.getMonth() - 1, 18);
                end = new Date(now.getFullYear(), now.getMonth(), 17);
            }
            start.setHours(0,0,0,0);
            end.setHours(23,59,59,999);
            return { start, end };
        }

        window.renderInsight = () => {
            let { start, end } = getPeriodRange();
            let pStr = `${start.getDate()} ${start.toLocaleString('id-ID',{month:'short'})} - ${end.getDate()} ${end.toLocaleString('id-ID',{month:'short'})}`;
            document.getElementById('insightPeriodLabel').innerText = pStr;

            let totalOmzet = 0;
            let totalVol = 0;
            let dayCounts = Array(7).fill(0); 
            let dateMap = {}; 

            let loopDate = new Date(start);
            while(loopDate <= end) {
                let dKey = loopDate.toLocaleDateString();
                dateMap[dKey] = { omzet:0, vol:0, hours:{}, isHoliday: data.holidays.includes(dKey) };
                loopDate.setDate(loopDate.getDate() + 1);
            }

            data.trans.forEach(t => {
                if (t.type === 'inc') {
                    let tDate = new Date(t.ts);
                    if (tDate >= start && tDate <= end) {
                        let dKey = t.date;
                        if(dateMap[dKey]) {
                            dateMap[dKey].omzet += t.n;
                            dateMap[dKey].vol += (t.l||0);
                            let h = parseInt(t.time.split(':')[0]);
                            if(!dateMap[dKey].hours[h]) dateMap[dKey].hours[h] = 0;
                            dateMap[dKey].hours[h]++;
                            dayCounts[tDate.getDay()] += t.n;
                            totalOmzet += t.n;
                            totalVol += (t.l||0);
                        }
                    }
                }
            });

            document.getElementById('insTotalOmzet').innerText = fmtMoney(totalOmzet);
            document.getElementById('insTotalVol').innerText = totalVol.toFixed(1) + " L";

            let maxDayVal = Math.max(...dayCounts);
            let dayLabels = ['Min','Sen','Sel','Rab','Kam','Jum','Sab'];
            let barHTML = dayCounts.map((val, i) => {
                let pct = maxDayVal > 0 ? (val / maxDayVal) * 100 : 0;
                return `<div class="day-bar-item"><div class="db-label">${dayLabels[i]}</div><div class="db-track"><div class="db-fill" style="width:${pct}%"></div></div><div class="db-val">${(val/1000).toFixed(0)}k</div></div>`;
            }).join('');
            document.getElementById('weeklyBarChart').innerHTML = barHTML;

            let calHTML = "";
            let sortedKeys = Object.keys(dateMap).sort((a,b) => {
                let da = a.split('/'); let db = b.split('/');
                return new Date(da[2], da[1]-1, da[0]) - new Date(db[2], db[1]-1, db[0]);
            });

            let firstDayIndex = new Date(start).getDay(); 
            for(let i=0; i<firstDayIndex; i++) calHTML += `<div class="cal-day cal-empty"></div>`;

            sortedKeys.forEach(k => {
                let item = dateMap[k];
                let sortedHours = Object.keys(item.hours).sort((a,b) => item.hours[b] - item.hours[a]).slice(0, 2);
                let peaksHTML = sortedHours.map(h => `<div class="peak-badge">${h}:00</div>`).join('');
                let holidayClass = item.isHoliday ? 'holiday' : '';
                let omzetDisplay = item.isHoliday ? 'LIBUR' : fmtMoney(item.omzet);
                calHTML += `<div class="cal-day ${holidayClass}" onclick="openDateDetail('${k}')"><div class="cd-date">${k.split('/')[0]}</div><div class="cd-omzet" style="${item.isHoliday?'color:var(--accent-pink);':''}">${omzetDisplay}</div><div class="cd-peaks">${peaksHTML}</div></div>`;
            });
            document.getElementById('calendarBody').innerHTML = calHTML;
        }

        window.openDateDetail = (dateStr) => {
            selectedDetailDate = dateStr;
            document.getElementById('ddTitle').innerText = "Detail: " + dateStr;
            document.getElementById('holidayToggle').checked = data.holidays.includes(dateStr);
            
            let hoursData = {};
            data.trans.forEach(t => {
                if(t.date === dateStr && t.type === 'inc') {
                    let h = t.time.split(':')[0] + ":00";
                    if(!hoursData[h]) hoursData[h] = 0;
                    hoursData[h] += t.n;
                }
            });

            let listHTML = Object.keys(hoursData).sort().map(h => `<div class="trans-item" style="padding:8px 0;"><span style="color:var(--text-muted); font-size:12px;">${h}</span><span style="font-weight:700; font-size:12px;">${fmtMoney(hoursData[h])}</span></div>`).join('');
            document.getElementById('ddHoursList').innerHTML = listHTML || '<div style="text-align:center;color:#666;font-size:12px;margin-top:10px;">Tidak ada transaksi</div>';
            document.getElementById('dateDetailModal').style.display = 'flex';
            toggleNav(false);
        }

        window.toggleHoliday = () => {
            if(!selectedDetailDate) return;
            let isHoliday = document.getElementById('holidayToggle').checked;
            if(isHoliday) { if(!data.holidays.includes(selectedDetailDate)) data.holidays.push(selectedDetailDate); } 
            else { data.holidays = data.holidays.filter(d => d !== selectedDetailDate); }
            localStorage.setItem('dl_super_v4', JSON.stringify(data));
            renderInsight(); 
        }

        // --- NEW: A4 REPORT (Full Page + 18-17 Period) ---
        window.generatePrintReport = () => {
            let { start, end } = getPeriodRange();
            let monthName = `${start.getDate()} ${start.toLocaleString('id-ID',{month:'short'})} - ${end.getDate()} ${end.toLocaleString('id-ID',{month:'short', year:'numeric'})}`;
            
            let tInc=0, tExp=0, tLit=0;
            let rows = '';
            
            // Filter Data based on 18-17 Range
            let monthlyTrans = data.trans.filter(t => {
                let d = new Date(t.ts);
                return d >= start && d <= end;
            }).sort((a,b) => a.ts - b.ts);

            monthlyTrans.forEach(t => {
                if(t.type==='inc') { tInc+=t.n; tLit+=(t.l||0); }
                else if(t.type!=='buy' && t.type!=='wd') { tExp+=t.n; }
                
                rows += `<tr style="border-bottom:1px solid #ddd;"><td style="padding:5px;">${t.date} ${t.time}</td><td style="padding:5px;">${t.type==='inc'?'PENJUALAN':(t.type==='buy'?'RESTOCK':(t.type==='wd'?'WITHDRAW':'BEBAN'))}</td><td style="padding:5px;">${t.desc||t.metode||'-'}</td><td style="padding:5px; text-align:right;">${t.type==='inc'?fmtMoney(t.n):'-'}</td><td style="padding:5px; text-align:right;">${t.type!=='inc'?fmtMoney(t.n):'-'}</td></tr>`;
            });

            let gross = tLit * 3000;
            let net = gross - tExp;

            let html = `
                <div style="font-family:sans-serif;">
                    <div style="text-align:center; margin-bottom:20px;">
                        <h2 style="margin:0;">${data.store}</h2>
                        <div style="font-size:12px;">${data.addr}</div>
                        <h3 style="margin:10px 0 0; text-decoration:underline;">LAPORAN KEUANGAN PERIODE</h3>
                        <div style="font-size:12px;">Periode: ${monthName}</div>
                    </div>
                    <table style="width:100%; border-collapse:collapse; margin-bottom:20px; font-size:12px;">
                        <tr><td style="padding:5px; font-weight:bold;">Total Penjualan (Omzet)</td><td style="padding:5px; text-align:right;">${fmtMoney(tInc)}</td></tr>
                        <tr><td style="padding:5px; font-weight:bold;">Total Liter Terjual</td><td style="padding:5px; text-align:right;">${tLit.toFixed(2)} L</td></tr>
                        <tr><td style="padding:5px; font-weight:bold;">Total Beban Operasional</td><td style="padding:5px; text-align:right; color:red;">(${fmtMoney(tExp)})</td></tr>
                        <tr style="background:#eee;"><td style="padding:5px; font-weight:bold;">NET PROFIT (Margin 3000)</td><td style="padding:5px; text-align:right; font-weight:bold;">${fmtMoney(net)}</td></tr>
                    </table>
                    <table style="width:100%; border-collapse:collapse; font-size:10px; border:1px solid #ccc;">
                        <thead style="background:#f0f0f0;"><tr><th style="padding:5px; text-align:left;">Waktu</th><th style="padding:5px; text-align:left;">Tipe</th><th style="padding:5px; text-align:left;">Ket</th><th style="padding:5px; text-align:right;">Masuk</th><th style="padding:5px; text-align:right;">Keluar</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                    <div style="margin-top:30px; text-align:right; font-size:12px;"><div>Dicetak pada: ${new Date().toLocaleString()}</div><br><br><br><div>( Admin )</div></div>
                </div>`;
            
            document.getElementById('printPreviewContent').innerHTML = html;
            document.getElementById('printArea').innerHTML = html;
        }

        window.doPrint = () => { window.print(); }

        // --- AI ASSISTANT ---
        window.sendAIChat = async () => {
            let i = document.getElementById('aiInput');
            let m = i.value;
            let b = document.getElementById('chatBox');
            if(!m) return; 
            i.value='';
            b.innerHTML += `<div style="background:var(--primary); color:white; margin-left:auto; border-radius:12px; padding:10px; margin-bottom:10px; max-width:80%; font-size:13px;">${m}</div>`;
            if(!data.groqKey){ b.innerHTML += `<div style="background:rgba(255,255,255,0.05); color:var(--accent-pink); border-radius:12px; padding:10px; margin-bottom:10px; font-size:12px;">Groq API Key belum diatur di Settings.</div>`; return; }
            b.innerHTML += `<div id="aiLoading" style="color:var(--text-muted); font-size:10px; margin-bottom:10px; font-style:italic;">Menganalisa data bisnis...</div>`;

            const oneDay = 24 * 60 * 60 * 1000;
            const now = Date.now();
            const getStats = (days) => {
                let s = { inc:0, exp:0, lit:0, count:0 };
                data.trans.forEach(t => { let diff = (now - t.ts) / oneDay; if(diff <= days) { if(t.type === 'inc') { s.inc += t.n; s.lit += (t.l||0); s.count++; } else if(t.type === 'exp') { s.exp += t.n; } } });
                return s;
            };
            let sDay = getStats(1); let sWeek = getStats(7); let sMonth = getStats(30); 
            let avgDailyLit = sWeek.lit > 0 ? (sWeek.lit / 7) : 0;
            let stockRunway = avgDailyLit > 0 ? (data.stokLiter / avgDailyLit).toFixed(1) : "Tidak terbatas (Belum ada penjualan)";
            let grossProfitMonth = sMonth.lit * 3000; 
            let netProfitMonth = grossProfitMonth - sMonth.exp;
            let efficiencyScore = sMonth.inc > 0 ? ((netProfitMonth / sMonth.inc) * 100).toFixed(1) : 0;

            let systemPrompt = `Peran: Business Analyst Senior. Fokus angka. 
            DATA: Stok: ${data.stokLiter.toFixed(2)}L. Avg Jual: ${avgDailyLit.toFixed(2)}L/hari. Prediksi Habis: ${stockRunway} hari.
            KEUANGAN: Hari Ini Omzet ${sDay.inc}. 7 Hari Omzet ${sWeek.inc}. 30 Hari Omzet ${sMonth.inc}.
            PROFIT (Bulan Ini): Gross ${grossProfitMonth}, Net ${netProfitMonth}, Efisiensi ${efficiencyScore}%.
            Pertanyaan User: "${m}"`;
            
            try{
                let r = await fetch("https://api.groq.com/openai/v1/chat/completions",{ method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${data.groqKey}`}, body:JSON.stringify({ model:"llama-3.3-70b-versatile", messages:[{role:"system",content:systemPrompt},{role:"user",content:m}] }) });
                let j = await r.json();
                document.getElementById('aiLoading').remove();
                b.innerHTML += `<div style="background:#333; color:white; margin-right:auto; border-radius:12px; padding:15px; margin-bottom:10px; max-width:85%; font-size:13px; line-height:1.6; border:1px solid rgba(255,255,255,0.1); box-shadow:0 5px 15px rgba(0,0,0,0.2);">${marked.parse(j.choices[0].message.content)}</div>`;
                b.scrollTop = b.scrollHeight;
            } catch(e){ document.getElementById('aiLoading').remove(); b.innerHTML += `<div style="color:var(--accent-pink); font-size:12px;">Gagal terhubung ke AI.</div>`; }
        }

        // --- KASBON ---
        window.openKasbon = () => { document.getElementById('kasbonModal').style.display='flex'; renderKasbon(); toggleNav(false); }
        window.renderKasbon = () => {
            let h = data.kasbon.map((k,i) => `<div class="trans-item"><div><div style="font-weight:600; color:white;">${k.name}</div><div style="font-size:11px; color:var(--text-muted);">${k.date}</div></div><div style="text-align:right;"><div style="font-weight:700; color:var(--accent-pink);">${fmtMoney(k.nom)}</div><span style="font-size:10px; padding:2px 8px; border-radius:4px; background:${k.lunas?'#2ECC71':'#333'}; color:white; cursor:pointer;" onclick="toggleLunas(${i})">${k.lunas?'PAID':'UNPAID'}</span></div></div>`).join('');
            document.getElementById('kasbonList').innerHTML = h || '<div style="text-align:center;color:#666;margin-top:20px;">No Data</div>';
        }
        window.addKasbon = () => { let nm=document.getElementById('kasbonName').value, no=parseInt(document.getElementById('kasbonNom').value); if(nm&&no){ data.kasbon.unshift({name:nm,nom:no,date:new Date().toLocaleDateString(),lunas:false}); localStorage.setItem('dl_super_v4',JSON.stringify(data)); document.getElementById('kasbonName').value=''; document.getElementById('kasbonNom').value=''; renderKasbon(); } }
        window.toggleLunas = (i) => { if(confirm("Ubah Status Lunas?")) { data.kasbon[i].lunas=!data.kasbon[i].lunas; localStorage.setItem('dl_super_v4',JSON.stringify(data)); renderKasbon(); } }

        // --- AUTH ---
        window.doLogin=()=>{if(document.getElementById('passInput').value===data.pass){localStorage.setItem('dl_log','1');nav('adminScreen');}else alert("Wrong PIN");}
        window.doLogout=()=>{localStorage.removeItem('dl_log');nav('loginScreen');}
        window.clearData=()=>{if(confirm("RESET ALL DATA PERMANENTLY?")){data.trans=[];data.kasbon=[];localStorage.setItem('dl_super_v4',JSON.stringify(data));renderDash();}}
        window.calcAdm = () => { let n=parseInt(document.getElementById('admNom').value)||0; document.getElementById('admLit').innerText=(n/data.price).toFixed(2)+"L"; }
        window.toggleWeather = () => {
            const i = document.querySelector('#weatherBtn .wt-icon');
            if(currentWeather === 'sunny') { currentWeather = 'rain'; i.innerText = 'thunderstorm'; i.style.color = '#4A6CFA'; }
            else { currentWeather = 'sunny'; i.innerText = 'wb_sunny'; i.style.color = '#FFD700'; }
        }

        // --- STARTUP ---
        const startApp=()=>{
            document.getElementById('splashScreen').style.opacity='0';
            setTimeout(()=>document.getElementById('splashScreen').style.display='none',500);
            if(localStorage.getItem('dl_log')) nav('adminScreen');
        }
        window.addEventListener('DOMContentLoaded', ()=>{setTimeout(startApp,2000)});
    </script>
</body>
</html>