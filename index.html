<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DEAR LOVE - Ultimate System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-body: #F1F5F9;
            --primary: #0F172A;
            --accent: #2563EB;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --white: #FFFFFF;
            --text-main: #1E293B;
            --text-sub: #64748B;
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-body); color: var(--text-main);
            height: 100vh; overflow: hidden;
        }

        /* --- SCREEN & LAYOUT --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); display: none; flex-direction: column; z-index: 1;
        }
        .screen.active { display: flex; animation: fadeIn 0.3s; }
        
        .scroll-content {
            flex: 1; overflow-y: auto; padding: 20px;
            padding-bottom: calc(100px + var(--safe-bottom)); 
            scrollbar-width: none;
        }
        .scroll-content::-webkit-scrollbar { display: none; }

        /* --- COMPONENTS --- */
        .top-nav {
            background: var(--white); padding: calc(var(--safe-top) + 15px) 24px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); z-index: 10;
        }
        .app-logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        
        /* Profile Photo Style (Clickable) */
        .profile-container {
            position: relative; cursor: pointer; transition: transform 0.1s;
        }
        .profile-container:active { transform: scale(0.95); }
        .profile-badge {
            position: absolute; bottom: 0; right: 0; background: var(--text-main); color: white;
            border-radius: 50%; padding: 2px; border: 2px solid white; font-size: 10px;
        }

        .card {
            background: var(--white); border-radius: 20px; padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 20px;
            border: 1px solid #E2E8F0;
        }

        /* --- STYLING BARU UNTUK SETTING (PREMIUM LOOK) --- */
        .setting-header {
            background: linear-gradient(135deg, var(--primary) 0%, #334155 100%);
            margin: -20px -20px 20px -20px; /* Melebar ke pinggir */
            padding: 40px 20px 60px 20px;
            border-radius: 0 0 30px 30px;
            text-align: center;
            color: white;
            position: relative;
        }
        .setting-avatar {
            width: 100px; height: 100px; border-radius: 50%; border: 4px solid white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); object-fit: cover;
            margin-bottom: 10px;
        }
        .setting-edit-btn {
            background: var(--accent); color: white; border: none; padding: 6px 15px;
            border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: inline-flex; align-items: center; gap: 5px;
        }
        
        /* Setting Groups (Card Style) */
        .setting-group {
            background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); position: relative; z-index: 2;
        }
        .setting-group.overlap { margin-top: -40px; } /* Naik ke atas header */
        
        .group-title {
            font-size: 11px; font-weight: 800; color: var(--text-sub); text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;
        }
        
/* Input Dasar (dibuat transparan/netral) */
        .clean-input { 
            width: 100%; padding: 15px; background: #F8FAFC; 
            border: none; border-radius: 12px; font-size: 16px; 
            margin-bottom: 15px; outline: none; 
        }

        /* --- PERBAIKAN POSISI ICON SETTING (FLEXBOX) --- */
        .setting-group input.clean-input { /* Target input di dalam setting group */
            padding: 0; /* HAPUS padding bawaan dari clean-input */
            margin: 0;  /* HAPUS margin bawah dari clean-input */
            background: transparent; /* Pastikan input transparan */
        }
        
        .input-wrap {
            display: flex; 
            align-items: center; /* KUNCI UTAMA: Biar pas di tengah vertikal */
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 0 15px; 
            margin-bottom: 15px;
            transition: all 0.3s ease;
            height: 50px; 
        }

        .input-wrap:focus-within {
            border-color: var(--accent);
            background: white;
            box-shadow: 0 4px 15px rgba(37,99,235,0.15);
            transform: translateY(-2px);
        }

        .input-wrap .icon {
            color: var(--text-sub);
            font-size: 22px;
            margin-right: 12px; 
            display: flex;
            align-items: center;
            justify-content: center;
            /* Flexbox memastikan ini di tengah */
        }

        .input-wrap input {
            border: none;
            background: transparent;
            width: 100%;
            height: 100%; 
            outline: none;
            font-size: 15px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main);
            /* Tidak perlu padding karena sudah dihandle oleh .input-wrap */
        }

        /* PROFIT CARD */
        .profit-card {
            background: linear-gradient(135deg, #0F172A 0%, #334155 100%); color: white;
            border-radius: 24px; padding: 25px; position: relative; overflow: hidden;
            margin-bottom: 25px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
        }
        .pc-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .pc-val { font-size: 32px; font-weight: 800; letter-spacing: -1px; margin-top: 5px; }
        .pc-sub { display: flex; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .pc-item h4 { margin: 0; font-size: 11px; opacity: 0.7; text-transform: uppercase; }
        .pc-item p { margin: 2px 0 0; font-size: 16px; font-weight: 700; }

        /* REPORT CARD (New) */
        .report-card {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 5px solid var(--primary);
        }
        .rc-header { display: flex; justify-content: space-between; font-weight: 700; font-size: 16px; margin-bottom: 15px; color: var(--primary); }
        .rc-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; color: var(--text-sub); }
        .rc-total { display: flex; justify-content: space-between; font-weight: 700; font-size: 14px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #E2E8F0; color: var(--text-main); }

        /* CHART REALTIME */
        .chart-box {
            height: 180px; display: flex; align-items: flex-end; justify-content: space-between; 
            gap: 5px; padding-top: 10px;
        }
        .chart-day { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
        .bar-group { width: 100%; display: flex; gap: 2px; align-items: flex-end; justify-content: center; height: 100%; }
        .bar { width: 40%; border-radius: 4px 4px 0 0; transition: height 0.5s; min-height: 4px; }
        .bar.inc { background: var(--success); }
        .bar.exp { background: var(--danger); }
        .day-lbl { font-size: 10px; color: var(--text-sub); margin-top: 5px; font-weight: 600; }

        /* LIST ITEM */
        .trans-item {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 0;
            border-bottom: 1px dashed #E2E8F0;
        }
        .ti-icon { 
            width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
            margin-right: 15px; font-size: 20px;
        }
        
        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 25px; left: 20px; right: 20px;
            background: var(--white); padding: 10px 25px; border-radius: 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 99;
        }
        .nav-btn { color: #94A3B8; cursor: pointer; padding: 10px; border-radius: 12px; transition: 0.2s; }
        .nav-btn.active { color: var(--accent); background: #EFF6FF; }
        .fab-main {
            width: 55px; height: 55px; background: var(--primary); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.4); margin-top: -35px; cursor: pointer;
        }

        /* MODAL */
        #inputModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: flex-end;
        }
        .sheet {
            background: var(--white); width: 100%; border-radius: 30px 30px 0 0;
            padding: 30px 25px 40px; animation: slideUp 0.3s;
        }
        .modal-tabs { display: flex; background: #F1F5F9; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .mt-btn { flex: 1; padding: 10px; text-align: center; font-size: 13px; font-weight: 700; color: var(--text-sub); border-radius: 10px; cursor: pointer; }
        .mt-btn.active { background: white; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .clean-input { width: 100%; padding: 15px; background: #F8FAFC; border: none; border-radius: 12px; font-size: 16px; margin-bottom: 15px; outline: none; }
        .btn-black { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 700; margin-bottom: 10px; cursor: pointer; }
        
        /* AI WIDGET */
        .ai-widget {
            background: linear-gradient(135deg, #8B5CF6 0%, #D946EF 100%); color: white;
            border-radius: 20px; padding: 20px; margin-bottom: 20px;
        }
        .prog-bg { background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .prog-fill { height: 100%; background: white; width: 0%; transition: width 0.5s; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="menuScreen" class="screen active">
        <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; padding:30px; text-align:center;">
            <img src="logo.png" style="width:80px; border-radius:20px; margin-bottom:20px;" onerror="this.style.display='none'">
            <h1 style="margin:0 0 5px; color:var(--primary);">DEAR LOVE</h1>
            <p style="color:var(--text-sub); margin-bottom:40px;">Ultimate Management System</p>
            <button onclick="nav('publicScreen')" class="btn-black" style="background:#EFF6FF; color:var(--accent);">Mode Kasir (Publik)</button>
            <button onclick="checkLogin()" class="btn-black">Login Admin</button>
        </div>
    </div>

    <div id="loginScreen" class="screen">
        <div style="padding:30px; display:flex; flex-direction:column; justify-content:center; height:100%;">
            <h2>Login Admin</h2>
            <input type="password" id="passInput" class="clean-input" placeholder="Masukkan Password...">
            <button class="btn-black" onclick="doLogin()">Masuk Dashboard</button>
            <div style="text-align:center; margin-top:20px; cursor:pointer; color:var(--text-sub);" onclick="nav('menuScreen')">Batal</div>
        </div>
    </div>

    <div id="publicScreen" class="screen">
        <div class="top-nav">
            <span class="material-icons-round" onclick="nav('menuScreen')">arrow_back</span>
            <span class="app-logo">KASIR PELANGGAN</span>
            <div style="width:24px"></div>
        </div>
        <div class="scroll-content">
            <div class="card" style="text-align:center;">
                <input type="number" id="pubNom" class="clean-input" style="font-size:24px; font-weight:bold; text-align:center;" placeholder="Rp 0" oninput="calcPub()">
                <div style="margin-bottom:20px;">Estimasi: <span id="pubLit" style="font-weight:bold; color:var(--accent);">0 L</span></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-black" onclick="window.print()">Print Struk</button>
                    <button class="btn-black" style="background:#25D366;" onclick="wa('pub')">WA</button>
                </div>
            </div>
            <div id="receiptArea" style="background:white; padding:20px; font-family:'Share Tech Mono'; font-size:12px; text-align:center; border:1px solid #eee; margin-top:20px;">
                <h3>DEAR LOVE</h3><p>Jl. Raya Pom Mini</p><hr>
                <div style="display:flex; justify-content:space-between;"><span id="rDate">-</span><span id="rTime">-</span></div><hr>
                <div style="text-align:left;">PERTALITE</div>
                <div style="display:flex; justify-content:space-between;"><span id="rDet">0 L</span><span id="rTot">0</span></div><hr>
                <h2 id="rBig">Rp 0</h2><p>TERIMA KASIH</p>
            </div>
        </div>
    </div>

    <div id="adminScreen" class="screen">
        <div class="top-nav">
            <span class="app-logo">Dashboard</span>
            
            <div class="profile-container" onclick="switchTab('tabSet', this)">
                <img id="dispPhoto" src="logo.png" style="width:40px; height:40px; border-radius:50%; background:#eee; object-fit:cover;">
                <div class="profile-badge"><span class="material-icons-round" style="font-size:12px;">settings</span></div>
            </div>
        </div>

        <div class="scroll-content">
            
            <div id="tabHome" class="tab-content active">
                
                <div id="pendingPayBox" style="background:#FEF3C7; border:1px solid #F59E0B; padding:15px; display:none; justify-content:space-between; align-items:center; border-radius:15px; margin-bottom:20px;">
                    <div>
                        <div style="font-size:11px; font-weight:bold; color:#B45309;">MENUNGGU PEMBAYARAN</div>
                        <div style="font-size:16px; font-weight:bold; color:#1F2937;" id="pendingNom">Rp 0</div>
                    </div>
                    <button onclick="markAsLunas()" style="background:#10B981; color:white; border:none; padding:8px 15px; border-radius:20px; font-weight:bold; font-size:12px;">LUNASKAN</button>
                </div>

                <div class="profit-card">
                    <span style="opacity:0.8; font-size:13px;">Net Profit (Bulan Ini)</span>
                    <div class="pc-row">
                        <div class="pc-val" id="netProfit">Rp 0</div>
                        <div style="background:rgba(255,255,255,0.2); padding:4px 10px; border-radius:15px; font-size:11px;">Margin: <span id="profitMargin">0%</span></div>
                    </div>
                    <div class="pc-sub">
                        <div class="pc-item"><h4>Pemasukan</h4><p style="color:#6EE7B7;" id="totInc">Rp 0</p></div>
                        <div class="pc-item"><h4>Pengeluaran</h4><p style="color:#FCA5A5;" id="totExp">Rp 0</p></div>
                    </div>
                </div>

                <div class="ai-widget">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px; font-weight:700;">
                        <span><span class="material-icons-round" style="font-size:14px; vertical-align:text-bottom;">psychology</span> AI ADVISOR</span>
                        <span id="limitText">Limit: Rp 0</span>
                    </div>
                    <p id="aiText" style="font-size:13px; margin:0 0 10px 0; line-height:1.4;">Analisa keuangan harian...</p>
                    <div class="prog-bg"><div class="prog-fill" id="expProgress"></div></div>
                    <button onclick="askAI()" style="margin-top:15px; width:100%; background:white; color:#7C3AED; border:none; padding:8px; border-radius:10px; font-weight:bold;">Analisa & Atur Budget</button>
                </div>

                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:10px;">Grafik 7 Hari</div>
                    <div class="chart-box" id="chartBox"></div>
                </div>

                <div class="card" style="background:#F0FDF4; border:1px solid #BBF7D0;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:#166534; font-weight:600; font-size:13px;">Stok BBM</span>
                        <span style="font-size:18px; font-weight:800; color:#15803D;" id="dispStok">0 L</span>
                    </div>
                    <div id="stokAlert" style="font-size:11px; margin-top:5px; color:#166534;">Status Aman</div>
                </div>

                <h3 style="font-size:16px; margin:0 0 10px 5px;">Transaksi Terakhir</h3>
                <div id="recentList"></div>
            </div>

            <div id="tabHist" class="tab-content">
                <h3>Riwayat Lengkap</h3>
                <div id="fullHistory"></div>
                <button class="btn-black" style="background:#FEE2E2; color:#EF4444; margin-top:20px;" onclick="clearData()">Hapus Semua Data</button>
            </div>

            <div id="tabRep" class="tab-content">
                <h3>Laporan Bulanan</h3>
                <div id="reportList"></div>
            </div>

            <div id="tabSet" class="tab-content">
                
                <div class="setting-header">
                    <img id="settingPhoto" class="setting-avatar" src="logo.png">
                    <div style="font-size:18px; font-weight:bold; margin-bottom:5px;">Admin Toko</div>
                    <label class="setting-edit-btn">
                        <span class="material-icons-round" style="font-size:14px;">photo_camera</span> Ganti Foto
                        <input type="file" onchange="updatePhoto(event)" style="display:none;">
                    </label>
                </div>

                <div class="setting-group overlap">
                    <div class="group-title">Informasi Usaha</div>
                    
                    <div class="input-wrap">
                        <span class="material-icons-round icon">store</span>
                        <input type="text" id="setStore" class="clean-input" placeholder="Nama Toko">
                    </div>
                    
                    <div class="input-wrap">
                        <span class="material-icons-round icon">place</span>
                        <input type="text" id="setAddr" class="clean-input" placeholder="Alamat Lengkap">
                    </div>

                    <div class="input-wrap">
                        <span class="material-icons-round icon">payments</span>
                        <input type="number" id="setPrice" class="clean-input" placeholder="Harga Jual / Liter">
                    </div>
                </div>

                <div class="setting-group">
                    <div class="group-title">Inventaris & Kecerdasan AI</div>

                    <div class="input-wrap">
                        <span class="material-icons-round icon">local_gas_station</span>
                        <input type="number" id="setStok" class="clean-input" placeholder="Stok Awal (Liter)">
                    </div>

                    <div class="input-wrap">
                        <span class="material-icons-round icon">warning_amber</span>
                        <input type="number" id="setMinStok" class="clean-input" placeholder="Batas Peringatan Stok (Contoh: 50)">
                    </div>

                    <div class="input-wrap">
                        <span class="material-icons-round icon">key</span>
                        <input type="text" id="setGroqKey" class="clean-input" placeholder="API Key Groq (Wajib untuk AI)">
                    </div>
                    <div style="font-size:10px; color:#64748B; margin-top:-10px; margin-bottom:10px;">
                        *Dapatkan Key gratis di console.groq.com
                    </div>
                </div>

                <button class="btn-black" onclick="saveSet()" style="box-shadow: 0 10px 20px rgba(15,23,42,0.2);">Simpan Perubahan</button>
                <button class="btn-black" onclick="doLogout()" style="background:#EF4444; margin-top:10px; box-shadow: 0 10px 20px rgba(239,68,68,0.2);">Keluar Akun</button>
                
                <div style="height:50px;"></div> </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-btn active" onclick="switchTab('tabHome', this)"><span class="material-icons-round">home</span></div>
            <div class="nav-btn" onclick="switchTab('tabHist', this)"><span class="material-icons-round">receipt_long</span></div>
            <div class="fab-main" onclick="openInputModal()"><span class="material-icons-round" style="font-size:28px;">add</span></div>
            <div class="nav-btn" onclick="openAIChat()"><span class="material-icons-round">smart_toy</span></div>
            <div class="nav-btn" onclick="switchTab('tabRep', this)"><span class="material-icons-round">description</span></div>
        </div>
    </div>

    <div id="inputModal">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Input Transaksi</h3>
                <span class="material-icons-round" onclick="closeModal()">close</span>
            </div>

            <div class="modal-tabs">
                <div class="mt-btn active" id="mtInc" onclick="setMode('inc')">Jual BBM</div>
                <div class="mt-btn" id="mtExp" onclick="setMode('exp')">Pengeluaran</div>
            </div>

            <input type="text" id="descInput" class="clean-input hidden" placeholder="Keterangan (Contoh: Listrik)...">
            <input type="number" id="admNom" class="clean-input" style="font-size:24px; font-weight:bold; color:var(--primary);" placeholder="Nominal (Rp)..." oninput="calcAdm()">
            
            <div id="litEstBox" style="text-align:right; font-size:13px; color:var(--text-sub); margin-bottom:20px;">
                Estimasi: <span id="admLit" style="font-weight:bold; color:var(--accent);">0 L</span>
            </div>

            <div id="actInc">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn-black" style="background:var(--success);" onclick="saveTrans('inc', 'cash')">Tunai (Struk)</button>
                    <button class="btn-black" style="background:var(--warning);" onclick="saveTrans('inc', 'qris')">Tagih QRIS</button>
                </div>
            </div>
            <div id="actExp" class="hidden">
                <button class="btn-black" style="background:var(--danger);" onclick="saveTrans('exp')">Simpan Pengeluaran</button>
            </div>

            <div id="adminReceiptArea" class="hidden">...</div>
        </div>
    </div>

    <div id="aiModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:300; display:none; justify-content:center; align-items:center;">
        <div style="width:90%; max-width:400px; height:70vh; background:white; border-radius:20px; display:flex; flex-direction:column; overflow:hidden;">
            <div style="padding:15px; background:var(--primary); color:white; display:flex; justify-content:space-between;">
                <span>Asisten Toko</span><span class="material-icons-round" onclick="document.getElementById('aiModal').style.display='none'">close</span>
            </div>
            <div id="chatBox" style="flex:1; padding:15px; overflow-y:auto; background:#F8FAFC;">
                <div style="background:white; padding:10px; border-radius:0 10px 10px 10px; font-size:13px; max-width:80%;">Halo! Ada yang bisa saya bantu?</div>
            </div>
            <div style="padding:10px; background:white; display:flex; gap:10px;">
                <input type="text" id="aiInput" class="clean-input" style="margin:0;" placeholder="Tanya...">
                <button onclick="sendAIChat()" class="btn-black" style="width:50px; margin:0;"><span class="material-icons-round">send</span></button>
            </div>
        </div>
    </div>

    <script type="module">
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyBpwNPIYhelOhkPvJsBmKvlZnaH9FVnmM4", authDomain: "pom-mini-50b1e.firebaseapp.com", projectId: "pom-mini-50b1e", storageBucket: "pom-mini-50b1e.firebasestorage.app", messagingSenderId: "77499696502", appId: "1:77499696502:web:8080c37da62a12c9566657", measurementId: "G-KRRHTTGBRF" };
        
        let db; 
        try { 
            firebase.initializeApp(firebaseConfig); 
            db = firebase.firestore();
            db.settings({ experimentalForceLongPolling: true, merge: true });
        } catch(e) { console.error("Firebase Error:", e); }


        // DATA INIT
        let data = JSON.parse(localStorage.getItem('dl_data')) || {
            pass: "DearLove2025", store: "DEAR LOVE", addr: "Jl. Raya", price: 10000, 
            admin: "Admin Owner", photo: "logo.png", groqKey: "",
            stokLiter: 500, minStok: 50, budgetLimit: 500000,
            trans: [] 
        };

        let currentMode = 'inc';
        let aiHistory = [{role: "system", content: "Kamu asisten bisnis."}];

        // NAVIGATION
        window.nav = (id) => { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='adminScreen') renderDash(); }
        window.checkLogin = () => { if(localStorage.getItem('dl_log')) nav('adminScreen'); else nav('loginScreen'); }
        window.doLogin = () => { if(document.getElementById('passInput').value===data.pass) { localStorage.setItem('dl_log','1'); nav('adminScreen'); } else alert("Salah"); }
        window.doLogout = () => { localStorage.removeItem('dl_log'); nav('menuScreen'); }
        
        window.switchTab = (tid, el) => { 
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); 
            document.getElementById(tid).classList.add('active'); 
            
            // Handle bottom nav active state
            document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active')); 
            if (tid === 'tabHome') { document.querySelector('.bottom-nav .nav-btn:nth-child(1)').classList.add('active'); }
            else if (tid === 'tabHist') { document.querySelector('.bottom-nav .nav-btn:nth-child(2)').classList.add('active'); }
            else if (tid === 'tabRep') { document.querySelector('.bottom-nav .nav-btn:nth-child(5)').classList.add('active'); }
            
            // Special render for reports
            if(tid === 'tabRep') renderReports();
        }

        // DASHBOARD RENDERER
        window.renderDash = () => {
            const today = new Date().toLocaleDateString();
            const curM = new Date().getMonth();
            let mInc=0, mExp=0, todayExp=0;

            data.trans.forEach(t => {
                let d = new Date(t.ts);
                if(d.getMonth() === curM) {
                    let type = t.type || 'inc';
                    if(type === 'inc') mInc += t.n; else mExp += t.n;
                }
                if(t.date === today && t.type === 'exp') todayExp += t.n;
            });

            document.getElementById('netProfit').innerText = "Rp " + (mInc - mExp).toLocaleString();
            document.getElementById('profitMargin').innerText = mInc > 0 ? (((mInc-mExp)/mInc)*100).toFixed(1) + "%" : "0%";
            document.getElementById('totInc').innerText = "Rp " + mInc.toLocaleString();
            document.getElementById('totExp').innerText = "Rp " + mExp.toLocaleString();
            document.getElementById('dispStok').innerText = parseFloat(data.stokLiter).toFixed(2) + " L";
            
            let sa = document.getElementById('stokAlert');
            if(data.stokLiter <= data.minStok) { sa.innerText="KRITIS! ISI ULANG"; sa.style.color="red"; } 
            else { sa.innerText="Status Aman"; sa.style.color="green"; }

            let pct = Math.min((todayExp / data.budgetLimit) * 100, 100);
            document.getElementById('expProgress').style.width = pct + "%";
            document.getElementById('limitText').innerText = `Limit: ${data.budgetLimit/1000}k | Pakai: ${todayExp/1000}k`;

            let html = "";
            data.trans.slice(0, 10).forEach(t => {
                let type = t.type || 'inc';
                let isInc = type === 'inc';
                let icon = isInc ? 'local_gas_station' : 'shopping_bag';
                let color = isInc ? 'var(--success)' : 'var(--danger)';
                let bg = isInc ? '#DCFCE7' : '#FEE2E2';
                let desc = isInc ? (t.metode||'Penjualan') : (t.desc||'Pengeluaran');
                
                html += `<div class="trans-item">
                    <div style="display:flex; align-items:center;">
                        <div class="ti-icon" style="background:${bg}; color:${color};"><span class="material-icons-round">${icon}</span></div>
                        <div><div style="font-weight:700; font-size:14px;">${desc}</div><div style="font-size:11px; color:#64748B;">${t.date} ${t.time}</div></div>
                    </div>
                    <div style="font-weight:700; color:${color};">${isInc?'+':'-'} Rp ${t.n.toLocaleString()}</div>
                </div>`;
            });
            document.getElementById('recentList').innerHTML = html;
            
            // Full History
             let fullHtml = "";
            data.trans.forEach(t => { 
                let type = t.type || 'inc';
                let isInc = type === 'inc';
                let icon = isInc ? 'local_gas_station' : 'shopping_bag';
                let color = isInc ? 'var(--success)' : 'var(--danger)';
                let bg = isInc ? '#DCFCE7' : '#FEE2E2';
                let desc = isInc ? (t.metode||'Penjualan') : (t.desc||'Pengeluaran');
                fullHtml += `<div class="trans-item">
                    <div style="display:flex; align-items:center;">
                        <div class="ti-icon" style="background:${bg}; color:${color};"><span class="material-icons-round">${icon}</span></div>
                        <div><div style="font-weight:700; font-size:14px;">${desc}</div><div style="font-size:11px; color:#64748B;">${t.date} ${t.time}</div></div>
                    </div>
                    <div style="font-weight:700; color:${color};">${isInc?'+':'-'} Rp ${t.n.toLocaleString()}</div>
                </div>`;
            });
            document.getElementById('fullHistory').innerHTML = fullHtml;
            renderChart();
        }

        // REPORT RENDERER
        window.renderReports = () => {
            let months = {};
            data.trans.forEach(t => {
                let d = new Date(t.ts);
                let key = d.toLocaleString('id-ID', { month: 'long', year: 'numeric' }); // ex: Desember 2025
                if(!months[key]) months[key] = { inc:0, exp:0 };
                
                let type = t.type || 'inc';
                if(type === 'inc') months[key].inc += t.n;
                else months[key].exp += t.n;
            });

            let html = Object.keys(months).map(k => {
                let m = months[k];
                let net = m.inc - m.exp;
                return `
                <div class="report-card">
                    <div class="rc-header">${k}</div>
                    <div class="rc-row"><span>Pemasukan</span><span style="color:var(--success)">+ Rp ${m.inc.toLocaleString()}</span></div>
                    <div class="rc-row"><span>Pengeluaran</span><span style="color:var(--danger)">- Rp ${m.exp.toLocaleString()}</span></div>
                    <div class="rc-total"><span>LABA BERSIH</span><span style="color:${net>=0?'var(--primary)':'var(--danger)'}">Rp ${net.toLocaleString()}</span></div>
                </div>`;
            }).join('');
            
            document.getElementById('reportList').innerHTML = html || "<div style='text-align:center; color:#aaa; margin-top:20px;'>Belum ada data transaksi</div>";
        }

        window.renderChart = () => {
            let days=[]; for(let i=6; i>=0; i--) { let d=new Date(); d.setDate(d.getDate()-i); days.push({k:d.toLocaleDateString(), l:d.toLocaleDateString('id',{weekday:'short'})}); }
            let cData = days.map(d => {
                let i=0, e=0;
                data.trans.forEach(t => { 
                    if(t.date === d.k) { if((t.type||'inc')==='inc') i+=t.n; else e+=t.n; } 
                });
                return {l:d.l, i, e};
            });
            let max = Math.max(...cData.map(c=>Math.max(c.i, c.e))) || 1;
            document.getElementById('chartBox').innerHTML = cData.map(c => `
                <div class="chart-day"><div class="bar-group">
                    <div class="bar inc" style="height:${(c.i/max)*100}%"></div>
                    <div class="bar exp" style="height:${(c.e/max)*100}%"></div>
                </div><div class="day-lbl">${c.l}</div></div>
            `).join('');
        }

        // MODAL & INPUT
        window.openInputModal = () => { document.getElementById('inputModal').style.display='flex'; }
        window.closeModal = () => { document.getElementById('inputModal').style.display='none'; }
        window.setMode = (m) => {
            currentMode = m;
            document.querySelectorAll('.mt-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(m==='inc'?'mtInc':'mtExp').classList.add('active');
            if(m==='exp') {
                document.getElementById('descInput').classList.remove('hidden');
                document.getElementById('litEstBox').classList.add('hidden');
                document.getElementById('actInc').classList.add('hidden');
                document.getElementById('actExp').classList.remove('hidden');
            } else {
                document.getElementById('descInput').classList.add('hidden');
                document.getElementById('litEstBox').classList.remove('hidden');
                document.getElementById('actInc').classList.remove('hidden');
                document.getElementById('actExp').classList.add('hidden');
            }
        }
        window.calcAdm = () => { if(currentMode==='inc') { let n=parseInt(document.getElementById('admNom').value)||0; document.getElementById('admLit').innerText = (n/data.price).toFixed(2)+" L"; }}

        window.saveTrans = async (type, method='cash') => {
            let n = parseInt(document.getElementById('admNom').value);
            if(!n) return;
            let now = new Date();
            let tx = { id:Date.now(), ts:now.getTime(), date:now.toLocaleDateString(), time:now.toLocaleTimeString(), type:type, n:n };
            if(type === 'inc') {
                let l = (n/data.price).toFixed(2);
                tx.l = l; tx.metode = method==='cash'?'CASH':'QRIS'; tx.status = method==='cash'?'PAID':'UNPAID';
                data.stokLiter = Math.max(0, data.stokLiter - l);
                if(db) { try { await db.collection("struk_public").doc("current").set({nominal:n, liter:l, shop:data.store, address:data.addr, waktu:now.toLocaleString(), status:tx.status, metode:tx.metode, timestamp:firebase.firestore.FieldValue.serverTimestamp()}); } catch(e){} }
            } else { tx.desc = document.getElementById('descInput').value || "Pengeluaran"; }
            data.trans.unshift(tx); localStorage.setItem('dl_data', JSON.stringify(data));
            document.getElementById('admNom').value=''; document.getElementById('descInput').value=''; closeModal(); renderDash();
        }

        if(db) {
            db.collection("struk_public").doc("current").onSnapshot(doc => {
                if(doc.exists && doc.data().status === "UNPAID") {
                    document.getElementById('pendingPayBox').style.display='flex';
                    document.getElementById('pendingNom').innerText="Rp "+parseInt(doc.data().nominal).toLocaleString();
                } else { document.getElementById('pendingPayBox').style.display='none'; }
            });
        }
        window.markAsLunas = async () => { if(db) await db.collection("struk_public").doc("current").update({status:"PAID"}); }

        // AI & SETTINGS
        window.openAIChat = () => { document.getElementById('aiModal').style.display='flex'; }
        
        window.sendAIChat = async () => {
            let inp = document.getElementById('aiInput'); 
            let msg = inp.value; 
            if(!msg) return;

            // Tampilkan Chat User
            let box = document.getElementById('chatBox');
            box.innerHTML += `<div style="text-align:right; margin:10px 0;"><span style="background:#E0E7FF; padding:8px 12px; border-radius:10px 0 10px 10px; font-size:13px;">${msg}</span></div>`;
            inp.value='';
            
            // Cek API Key
            if(!data.groqKey) { 
                box.innerHTML += `<div style="margin:10px 0; text-align:left;"><span style="background:#FEE2E2; color:red; padding:8px; border-radius:0 10px 10px 10px; font-size:12px;">⚠️ API Key Kosong! Masuk ke Pengaturan dan isi API Key Groq.</span></div>`; 
                return; 
            }

            let prompt = `Role: Asisten Bisnis Pom Mini. Stok BBM: ${data.stokLiter}L, Harga Jual: ${data.price}. Pertanyaan: ${msg}`;
            let loadingId = "loading-" + Date.now();
            box.innerHTML += `<div id="${loadingId}" style="margin:10px 0; text-align:left;"><span style="background:white; padding:8px; border-radius:0 10px 10px 10px; font-size:11px; color:#aaa;"><i>Sedang mengetik...</i></span></div>`;
            box.scrollTop = box.scrollHeight;

            try {
                let res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", 
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${data.groqKey}` },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{role:"user", content:prompt}] })
                });

                if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                let json = await res.json();
                let reply = json.choices[0].message.content;
                document.getElementById(loadingId).remove();
                box.innerHTML += `<div style="margin:10px 0; text-align:left;"><span style="background:white; padding:8px 12px; border-radius:0 10px 10px 10px; font-size:13px; display:inline-block; line-height:1.4;">${marked.parse(reply)}</span></div>`;
            } catch(e) {
                document.getElementById(loadingId).remove();
                box.innerHTML += `<div style="margin:10px 0; text-align:left;"><span style="background:#FEE2E2; color:#EF4444; padding:8px; border-radius:0 10px 10px 10px; font-size:12px;">❌ Gagal Terhubung. (${e.message})</span></div>`;
            }
            box.scrollTop = box.scrollHeight;
        }

        window.askAI = async () => {
             let btn = document.querySelector('.ai-widget button');
             let txt = document.getElementById('aiText');

             if(!data.groqKey) { alert("API Key Groq Kosong! Harap isi di menu Pengaturan."); return; }
             
             btn.innerText = "Menganalisa..."; btn.disabled = true;

             try {
                 let prompt = `Analisa keuangan singkat untuk toko BBM. Pemasukan hari ini Rp ${document.getElementById('totInc').innerText}, Pengeluaran Rp ${document.getElementById('totExp').innerText}. Stok ${data.stokLiter}L.`;
                 let res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${data.groqKey}` },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{role:"user", content:prompt}] })
                });
                if (!res.ok) throw new Error("API Key Salah / Kuota Habis");
                let json = await res.json();
                txt.innerHTML = marked.parse(json.choices[0].message.content); 
             } catch (e) {
                 txt.innerText = "Gagal memuat analisa. Periksa internet atau API Key Anda.";
             }
             btn.innerText = "Analisa Ulang"; btn.disabled = false;
        }


        window.saveSet = () => {
            data.store = document.getElementById('setStore').value; data.addr = document.getElementById('setAddr').value;
            data.price = parseInt(document.getElementById('setPrice').value); data.stokLiter = parseFloat(document.getElementById('setStok').value);
            data.minStok = parseFloat(document.getElementById('setMinStok').value); data.groqKey = document.getElementById('setGroqKey').value;
            localStorage.setItem('dl_data', JSON.stringify(data)); renderDash(); alert("Pengaturan Disimpan!");
            // Pastikan photo juga disimpan setelah diupdate
            document.getElementById('dispPhoto').src = data.photo;
            document.getElementById('settingPhoto').src = data.photo;
        }

        window.calcPub = () => { let n=parseInt(document.getElementById('pubNom').value)||0; let l=(n/data.price).toFixed(2); document.getElementById('pubLit').innerText=l+" L"; document.getElementById('rBig').innerText="Rp "+n.toLocaleString(); document.getElementById('rDet').innerText=l+" L"; document.getElementById('rTot').innerText=n.toLocaleString(); }
        window.wa = () => { window.open(`https://wa.me/?text=Struk Rp ${document.getElementById('pubNom').value}`, '_blank'); }
        window.clearData = () => { if(confirm("Hapus semua?")) { data.trans=[]; localStorage.setItem('dl_data', JSON.stringify(data)); renderDash(); } }

        window.onload = () => { 
            if(localStorage.getItem('dl_log')) nav('adminScreen');
            document.getElementById('setStore').value = data.store; document.getElementById('setAddr').value = data.addr;
            document.getElementById('setPrice').value = data.price; document.getElementById('setStok').value = data.stokLiter;
            document.getElementById('setMinStok').value = data.minStok; document.getElementById('setGroqKey').value = data.groqKey;
            
            // Load Photo
            document.getElementById('dispPhoto').src = data.photo;
            document.getElementById('settingPhoto').src = data.photo;
        }
        window.updatePhoto = (e) => { let f=e.target.files[0]; if(f){ let r=new FileReader(); r.onload=(v)=>{data.photo=v.target.result; renderDash(); document.getElementById('dispPhoto').src=data.photo; document.getElementById('settingPhoto').src=data.photo; localStorage.setItem('dl_data', JSON.stringify(data));}; r.readAsDataURL(f); } }
    </script>
</body>
</html>